
<article>
---
title: 'äº‹åŠ¡å’Œæ‰¹é‡æŸ¥è¯¢'
metaTitle: 'äº‹åŠ¡å’Œæ‰¹é‡æŸ¥è¯¢ (å‚è€ƒ)'
metaDescription: 'æ­¤é¡µé¢è§£é‡Šäº† Prisma Client çš„äº‹åŠ¡ APIã€‚'
tocDepth: 3
---

<TopBlock>

æ•°æ®åº“äº‹åŠ¡æŒ‡çš„æ˜¯ä¸€ç³»åˆ—è¯»/å†™æ“ä½œï¼Œè¿™äº›æ“ä½œè¢«*ä¿è¯*è¦ä¹ˆä½œä¸ºä¸€ä¸ªæ•´ä½“æˆåŠŸï¼Œè¦ä¹ˆä½œä¸ºä¸€ä¸ªæ•´ä½“å¤±è´¥ã€‚æœ¬èŠ‚æè¿°äº† Prisma Client API æ”¯æŒäº‹åŠ¡çš„æ–¹å¼ã€‚

</TopBlock>

## äº‹åŠ¡æ¦‚è¿°

<Admonition type="info">

åœ¨ Prisma ORM ç‰ˆæœ¬ 4.4.0 ä¹‹å‰ï¼Œæ‚¨æ— æ³•åœ¨äº‹åŠ¡ä¸Šè®¾ç½®éš”ç¦»çº§åˆ«ã€‚æ•°æ®åº“é…ç½®ä¸­çš„éš”ç¦»çº§åˆ«å§‹ç»ˆé€‚ç”¨ã€‚

</Admonition>

å¼€å‘äººå‘˜é€šè¿‡å°†æ“ä½œåŒ…è£…åœ¨äº‹åŠ¡ä¸­æ¥åˆ©ç”¨æ•°æ®åº“æä¾›çš„å®‰å…¨ä¿è¯ã€‚è¿™äº›ä¿è¯é€šå¸¸ä½¿ç”¨ ACID é¦–å­—æ¯ç¼©ç•¥è¯æ¥æ¦‚æ‹¬ï¼š

-   **åŸå­æ€§ï¼ˆAtomicï¼‰**: ç¡®ä¿äº‹åŠ¡çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆ*å…¨éƒ¨*æˆåŠŸï¼Œè¦ä¹ˆ*å…¨éƒ¨*å¤±è´¥ã€‚äº‹åŠ¡è¦ä¹ˆæˆåŠŸ*æäº¤*ï¼Œè¦ä¹ˆ*ä¸­æ­¢*å¹¶*å›æ»š*ã€‚
-   **ä¸€è‡´æ€§ï¼ˆConsistentï¼‰**: ç¡®ä¿äº‹åŠ¡å‰åæ•°æ®åº“çš„çŠ¶æ€éƒ½æ˜¯*æœ‰æ•ˆçš„*ï¼ˆå³ï¼Œå…³äºæ•°æ®çš„ä»»ä½•ç°æœ‰ä¸å˜æ€§éƒ½å¾—ä»¥ç»´æŠ¤ï¼‰ã€‚
-   **éš”ç¦»æ€§ï¼ˆIsolatedï¼‰**: ç¡®ä¿å¹¶å‘è¿è¡Œçš„äº‹åŠ¡å…·æœ‰ä¸å®ƒä»¬ä¸²è¡Œè¿è¡Œæ—¶ç›¸åŒçš„æ•ˆæœã€‚
-   **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**: ç¡®ä¿äº‹åŠ¡æˆåŠŸåï¼Œä»»ä½•å†™å…¥éƒ½å°†è¢«æŒä¹…å­˜å‚¨ã€‚

è™½ç„¶è¿™äº›å±æ€§ä¸­çš„æ¯ä¸€ä¸ªéƒ½æœ‰å¾ˆå¤šæ¨¡ç³Šæ€§å’Œç»†å¾®å·®åˆ«ï¼ˆä¾‹å¦‚ï¼Œä¸€è‡´æ€§å®é™…ä¸Šå¯ä»¥è¢«è®¤ä¸ºæ˜¯*åº”ç”¨å±‚é¢çš„è´£ä»»*è€Œä¸æ˜¯æ•°æ®åº“å±æ€§ï¼Œæˆ–è€…éš”ç¦»æ€§é€šå¸¸ä»¥æ›´å¼ºå’Œæ›´å¼±çš„*éš”ç¦»çº§åˆ«*æ¥ä¿è¯ï¼‰ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œå®ƒä»¬ä¸ºå¼€å‘äººå‘˜åœ¨è€ƒè™‘æ•°æ®åº“äº‹åŠ¡æ—¶çš„æœŸæœ›æä¾›äº†ä¸€ä¸ªè‰¯å¥½çš„é«˜çº§æŒ‡å¯¼ã€‚

> â€œäº‹åŠ¡æ˜¯ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºå‡è£…æŸäº›å¹¶å‘é—®é¢˜ä»¥åŠæŸäº›ç±»å‹çš„ç¡¬ä»¶å’Œè½¯ä»¶æ•…éšœä¸å­˜åœ¨ã€‚ä¸€å¤§ç±»é”™è¯¯è¢«ç®€åŒ–ä¸ºç®€å•çš„äº‹åŠ¡ä¸­æ­¢ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦é‡è¯•å³å¯ã€‚â€ [ã€Šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ã€‹](https://dataintensive.net/), [Martin Kleppmann](https://bsky.app/profile/martin.kleppmann.com)

Prisma Client æ”¯æŒå…­ç§ä¸åŒçš„æ–¹å¼æ¥å¤„ç†ä¸‰ç§ä¸åŒåœºæ™¯ä¸‹çš„äº‹åŠ¡ï¼š

| åœºæ™¯            | å¯ç”¨æŠ€æœ¯                                                                                              |
| :------------------ | :-------------------------------------------------------------------------------------------------------------- |
| ä¾èµ–å†™å…¥ (Dependent writes)    | <ul><li>åµŒå¥—å†™å…¥ (Nested writes)</li></ul>                                                                                 |
| ç‹¬ç«‹å†™å…¥ (Independent writes)  | <ul><li>`$transaction([])` API</li><li>æ‰¹é‡æ“ä½œ (Batch operations)</li></ul>                                               |
| è¯»å–ã€ä¿®æ”¹ã€å†™å…¥ (Read, modify, write) | <ul><li>å¹‚ç­‰æ“ä½œ (Idempotent operations)</li><li>ä¹è§‚å¹¶å‘æ§åˆ¶ (Optimistic concurrency control)</li><li>äº¤äº’å¼äº‹åŠ¡ (Interactive transactions)</li></ul> |

æ‚¨é€‰æ‹©çš„æŠ€æœ¯å–å†³äºæ‚¨çš„ç‰¹å®šç”¨ä¾‹ã€‚

> **æ³¨æ„**: å°±æœ¬æŒ‡å—è€Œè¨€ï¼Œ*å†™å…¥*æ•°æ®åº“åŒ…æ‹¬åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ•°æ®ã€‚

## å…³äº Prisma Client ä¸­çš„äº‹åŠ¡

Prisma Client æä¾›äº†ä»¥ä¸‹ä½¿ç”¨äº‹åŠ¡çš„é€‰é¡¹ï¼š

-   [åµŒå¥—å†™å…¥](#nested-writes)ï¼šä½¿ç”¨ Prisma Client API åœ¨åŒä¸€äº‹åŠ¡å†…å¤„ç†å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å…³è®°å½•çš„å¤šä¸ªæ“ä½œã€‚
-   [æ‰¹é‡æ“ä½œ](#batchbulk-operations)ï¼šä½¿ç”¨ `updateMany`ã€`deleteMany` å’Œ `createMany` æ‰¹é‡å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œã€‚
-   Prisma Client ä¸­çš„ `$transaction` APIï¼š
    -   [é¡ºåºæ“ä½œ](#sequential-prisma-client-operations)ï¼šä¼ é€’ä¸€ä¸ª Prisma Client æŸ¥è¯¢æ•°ç»„ï¼Œè¿™äº›æŸ¥è¯¢å°†åœ¨äº‹åŠ¡å†…æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½¿ç”¨ `$transaction<R>(queries: PrismaPromise<R>[]): Promise<R[]>`ã€‚
    -   [äº¤äº’å¼äº‹åŠ¡](#interactive-transactions)ï¼šä¼ é€’ä¸€ä¸ªå¯ä»¥åŒ…å«ç”¨æˆ·ä»£ç ï¼ˆåŒ…æ‹¬ Prisma Client æŸ¥è¯¢ã€é Prisma ä»£ç å’Œå…¶ä»–æ§åˆ¶æµï¼‰çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä½¿ç”¨ `$transaction<R>(fn: (prisma: PrismaClient) => R, options?: object): R`ã€‚

## åµŒå¥—å†™å…¥ (Nested writes)

[åµŒå¥—å†™å…¥](/orm/prisma-client/queries/relation-queries#nested-writes) å…è®¸æ‚¨æ‰§è¡Œå•ä¸ª Prisma Client API è°ƒç”¨ï¼Œå…¶ä¸­åŒ…å«æ¶‰åŠå¤šä¸ª [_ç›¸å…³_](/orm/prisma-schema/data-model/relations) è®°å½•çš„å¤šä¸ª*æ“ä½œ*ã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ª*ç”¨æˆ·*ä»¥åŠä¸€ç¯‡*å¸–å­*ï¼Œæˆ–è€…æ›´æ–°ä¸€ä¸ª*è®¢å•*ä»¥åŠä¸€å¼ *å‘ç¥¨*ã€‚Prisma Client ç¡®ä¿æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†ä½¿ç”¨ `create` è¿›è¡Œçš„åµŒå¥—å†™å…¥ï¼š

```ts
// åœ¨å•ä¸ªäº‹åŠ¡ä¸­åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·å’Œä¸¤ç¯‡å¸–å­
const newUser: User = await prisma.user.create({
  data: {
    email: 'alice@prisma.io',
    posts: {
      create: [
        { title: 'åœ¨ https://pris.ly/discord åŠ å…¥ Prisma Discord' },
        { title: 'åœ¨ Twitter ä¸Šå…³æ³¨ @prisma' },
      ],
    },
  },
})
```

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†ä½¿ç”¨ `update` è¿›è¡Œçš„åµŒå¥—å†™å…¥ï¼š

```ts
// åœ¨å•ä¸ªäº‹åŠ¡ä¸­æ›´æ”¹å¸–å­çš„ä½œè€…
const updatedPost: Post = await prisma.post.update({
  where: { id: 42 },
  data: {
    author: {
      connect: { email: 'alice@prisma.io' },
    },
  },
})
```

## æ‰¹é‡æ“ä½œ (Batch/bulk operations)

ä»¥ä¸‹æ‰¹é‡æ“ä½œä½œä¸ºäº‹åŠ¡è¿è¡Œï¼š

-   `createMany()`
-   `createManyAndReturn()`
-   `updateMany()`
-   `updateManyAndReturn()`
-   `deleteMany()`

> è¯·å‚è€ƒå…³äº[æ‰¹é‡æ“ä½œ](#bulk-operations)çš„éƒ¨åˆ†ä»¥è·å–æ›´å¤šç¤ºä¾‹ã€‚

## `$transaction` API

`$transaction` API å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ä½¿ç”¨ï¼š

-   [é¡ºåºæ“ä½œ](#sequential-prisma-client-operations)ï¼šä¼ é€’ä¸€ä¸ª Prisma Client æŸ¥è¯¢æ•°ç»„ï¼Œè¿™äº›æŸ¥è¯¢å°†åœ¨äº‹åŠ¡å†…æŒ‰é¡ºåºæ‰§è¡Œã€‚

    `$transaction<R>(queries: PrismaPromise<R>[]): Promise<R[]>`

-   [äº¤äº’å¼äº‹åŠ¡](#interactive-transactions)ï¼šä¼ é€’ä¸€ä¸ªå¯ä»¥åŒ…å«ç”¨æˆ·ä»£ç ï¼ˆåŒ…æ‹¬ Prisma Client æŸ¥è¯¢ã€é Prisma ä»£ç å’Œå…¶ä»–æ§åˆ¶æµï¼‰çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œã€‚

    `$transaction<R>(fn: (prisma: PrismaClient) => R): R`

### é¡ºåº Prisma Client æ“ä½œ

ä»¥ä¸‹æŸ¥è¯¢è¿”å›æ‰€æœ‰åŒ¹é…æ‰€æä¾›è¿‡æ»¤å™¨çš„å¸–å­ä»¥åŠæ‰€æœ‰å¸–å­çš„è®¡æ•°ï¼š

```ts
const [posts, totalPosts] = await prisma.$transaction([
  prisma.post.findMany({ where: { title: { contains: 'prisma' } } }),
  prisma.post.count(),
])
```

æ‚¨ä¹Ÿå¯ä»¥åœ¨ `$transaction` ä¸­ä½¿ç”¨åŸå§‹æŸ¥è¯¢ï¼š

<TabbedContent code>

<TabItem value="å…³ç³»å‹æ•°æ®åº“">

```ts
import { selectUserTitles, updateUserName } from '@prisma/client/sql'

const [userList, updateUser] = await prisma.$transaction([
  prisma.$queryRawTyped(selectUserTitles()),
  prisma.$queryRawTyped(updateUserName(2)),
])
```

</TabItem>

<TabItem value="MongoDB">

```ts
const [findRawData, aggregateRawData, commandRawData] =
  await prisma.$transaction([
    prisma.user.findRaw({
      filter: { age: { $gt: 25 } },
    }),
    prisma.user.aggregateRaw({
      pipeline: [
        { $match: { status: 'registered' } },
        { $group: { _id: '$country', total: { $sum: 1 } } },
      ],
    }),
    prisma.$runCommandRaw({
      aggregate: 'User',
      pipeline: [
        { $match: { name: 'Bob' } },
        { $project: { email: true, _id: false } },
      ],
      explain: false,
    }),
  ])
```

</TabItem>

</TabbedContent>

æ“ä½œæœ¬èº«é¦–å…ˆå­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œè€Œä¸æ˜¯åœ¨æ‰§è¡Œæ—¶ç«‹å³ç­‰å¾…æ¯ä¸ªæ“ä½œçš„ç»“æœï¼Œç„¶åä½¿ç”¨åä¸º `$transaction` çš„æ–¹æ³•å°†è¿™äº›æ“ä½œæäº¤åˆ°æ•°æ®åº“ã€‚Prisma Client å°†ç¡®ä¿æ‰€æœ‰ä¸‰ä¸ª `create` æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

> **æ³¨æ„**: æ“ä½œæŒ‰ç…§å®ƒä»¬åœ¨äº‹åŠ¡ä¸­æ”¾ç½®çš„é¡ºåºæ‰§è¡Œã€‚åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨æŸ¥è¯¢ä¸ä¼šå½±å“æŸ¥è¯¢æœ¬èº«å†…éƒ¨æ“ä½œçš„é¡ºåºã€‚
>
> è¯·å‚è€ƒå…³äº[äº‹åŠ¡ API](#transaction-api)çš„éƒ¨åˆ†ä»¥è·å–æ›´å¤šç¤ºä¾‹ã€‚

ä»ç‰ˆæœ¬ 4.4.0 å¼€å§‹ï¼Œé¡ºåºæ“ä½œäº‹åŠ¡ API æœ‰ç¬¬äºŒä¸ªå‚æ•°ã€‚æ‚¨å¯ä»¥åœ¨æ­¤å‚æ•°ä¸­ä½¿ç”¨ä»¥ä¸‹å¯é€‰é…ç½®é€‰é¡¹ï¼š

-   `isolationLevel`ï¼šè®¾ç½®[äº‹åŠ¡éš”ç¦»çº§åˆ«](#transaction-isolation-level)ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™è¢«è®¾ç½®ä¸ºæ‚¨æ•°æ®åº“å½“å‰é…ç½®çš„å€¼ã€‚

ä¾‹å¦‚ï¼š

```ts
await prisma.$transaction(
  [
    prisma.resource.deleteMany({ where: { name: 'name' } }),
    prisma.resource.createMany({ data }),
  ],
  {
    isolationLevel: Prisma.TransactionIsolationLevel.Serializable, // å¯é€‰ï¼Œé»˜è®¤ç”±æ•°æ®åº“é…ç½®å®šä¹‰
  }
)
```

### äº¤äº’å¼äº‹åŠ¡ (Interactive transactions)

#### æ¦‚è¿°

æœ‰æ—¶æ‚¨éœ€è¦å¯¹äº‹åŠ¡å†…æ‰§è¡Œçš„æŸ¥è¯¢æœ‰æ›´å¤šçš„æ§åˆ¶ã€‚äº¤äº’å¼äº‹åŠ¡æ—¨åœ¨ä¸ºæ‚¨æä¾›ä¸€ç§åº”æ€¥æ–¹æ¡ˆã€‚

<Admonition type="info">

äº¤äº’å¼äº‹åŠ¡è‡ªç‰ˆæœ¬ 4.7.0 èµ·å·²æ­£å¼å¯ç”¨ã€‚

å¦‚æœæ‚¨åœ¨ç‰ˆæœ¬ 2.29.0 åˆ° 4.6.1ï¼ˆå«ï¼‰çš„é¢„è§ˆç‰ˆä¸­ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡ï¼Œæ‚¨éœ€è¦åœ¨ Prisma schema çš„ generator å—ä¸­æ·»åŠ  `interactiveTransactions` é¢„è§ˆåŠŸèƒ½ã€‚

</Admonition>

è¦ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡ï¼Œæ‚¨å¯ä»¥å°†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¼ é€’ç»™ [`$transaction`](#transaction-api)ã€‚

ä¼ é€’ç»™æ­¤å¼‚æ­¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Prisma Client çš„ä¸€ä¸ªå®ä¾‹ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ç§°æ­¤å®ä¾‹ä¸º `tx`ã€‚åœ¨æ­¤ `tx` å®ä¾‹ä¸Šè°ƒç”¨çš„ä»»ä½• Prisma Client è°ƒç”¨éƒ½å°è£…åœ¨äº‹åŠ¡ä¸­ã€‚

<Admonition type="warning">

**è¯·è°¨æ…ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡**ã€‚é•¿æ—¶é—´ä¿æŒäº‹åŠ¡æ‰“å¼€ä¼šæŸå®³æ•°æ®åº“æ€§èƒ½ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´æ­»é”ã€‚å°½é‡é¿å…åœ¨äº‹åŠ¡å‡½æ•°å†…éƒ¨æ‰§è¡Œç½‘ç»œè¯·æ±‚å’Œæ…¢æŸ¥è¯¢ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å°½å¿«å®Œæˆå¹¶é€€å‡ºï¼

</Admonition>

#### ç¤ºä¾‹

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

å‡è®¾æ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªåœ¨çº¿é“¶è¡Œç³»ç»Ÿã€‚è¦æ‰§è¡Œçš„æ“ä½œä¹‹ä¸€æ˜¯ä»ä¸€ä¸ªäººå‘å¦ä¸€ä¸ªäººè½¬è´¦ã€‚

ä½œä¸ºç»éªŒä¸°å¯Œçš„å¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿åœ¨è½¬è´¦è¿‡ç¨‹ä¸­ï¼Œ

-   é‡‘é¢ä¸ä¼šæ¶ˆå¤±
-   é‡‘é¢ä¸ä¼šè¢«åŠ å€

è¿™æ˜¯ä¸€ä¸ªéå¸¸é€‚åˆä½¿ç”¨äº¤äº’å¼äº‹åŠ¡çš„ç”¨ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨å†™å…¥ä¹‹é—´æ‰§è¡Œé€»è¾‘æ¥æ£€æŸ¥ä½™é¢ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ŒAlice å’Œ Bob çš„è´¦æˆ·å„æœ‰ 100 ç¾å…ƒã€‚å¦‚æœä»–ä»¬è¯•å›¾å‘é€è¶…è¿‡ä»–ä»¬æ‹¥æœ‰çš„é‡‘é¢ï¼Œè½¬è´¦å°†è¢«æ‹’ç»ã€‚

é¢„è®¡ Alice èƒ½å¤ŸæˆåŠŸè¿›è¡Œä¸€æ¬¡ 100 ç¾å…ƒçš„è½¬è´¦ï¼Œè€Œå¦ä¸€æ¬¡è½¬è´¦å°†è¢«æ‹’ç»ã€‚è¿™å°†å¯¼è‡´ Alice æ‹¥æœ‰ 0 ç¾å…ƒï¼Œè€Œ Bob æ‹¥æœ‰ 200 ç¾å…ƒã€‚

```tsx
import { PrismaClient } from '@prisma/client'
const prisma = new PrismaClient()

function transfer(from: string, to: string, amount: number) {
  return prisma.$transaction(async (tx) => {
    // 1. ä»å‘é€æ–¹è´¦æˆ·æ‰£é™¤é‡‘é¢ã€‚
    const sender = await tx.account.update({
      data: {
        balance: {
          decrement: amount,
        },
      },
      where: {
        email: from,
      },
    })

    // 2. éªŒè¯å‘é€æ–¹çš„ä½™é¢æ²¡æœ‰ä½äºé›¶ã€‚
    if (sender.balance < 0) {
      throw new Error(`${from} æ²¡æœ‰è¶³å¤Ÿçš„é’±å‘é€ ${amount}`)
    }

    // 3. å°†æ”¶æ¬¾æ–¹çš„ä½™é¢å¢åŠ ç›¸åº”é‡‘é¢ã€‚
    const recipient = await tx.account.update({
      data: {
        balance: {
          increment: amount,
        },
      },
      where: {
        email: to,
      },
    })

    return recipient
  })
}

async function main() {
  // è¿™æ¬¡è½¬è´¦æˆåŠŸ
  await transfer('alice@prisma.io', 'bob@prisma.io', 100)
  // è¿™æ¬¡è½¬è´¦å¤±è´¥ï¼Œå› ä¸º Alice è´¦æˆ·ä½™é¢ä¸è¶³
  await transfer('alice@prisma.io', 'bob@prisma.io', 100)
}

main()
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸¤ä¸ª `update` æŸ¥è¯¢éƒ½åœ¨æ•°æ®åº“äº‹åŠ¡å†…è¿è¡Œã€‚å½“åº”ç”¨ç¨‹åºåˆ°è¾¾å‡½æ•°æœ«å°¾æ—¶ï¼Œäº‹åŠ¡å°†**æäº¤**åˆ°æ•°æ®åº“ã€‚

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨æ­¤è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œå¼‚æ­¥å‡½æ•°å°†æŠ›å‡ºå¼‚å¸¸å¹¶è‡ªåŠ¨**å›æ»š**äº‹åŠ¡ã€‚

è¦æ•è·å¼‚å¸¸ï¼Œæ‚¨å¯ä»¥å°† `$transaction` åŒ…è£…åœ¨ try-catch å—ä¸­ï¼š

```js
try {
  await prisma.$transaction(async (tx) => {
    // åœ¨äº‹åŠ¡ä¸­è¿è¡Œçš„ä»£ç ...
  })
} catch (err) {
  // å¤„ç†å›æ»š...
}
```

#### äº‹åŠ¡é€‰é¡¹

äº‹åŠ¡ API æœ‰ç¬¬äºŒä¸ªå‚æ•°ã€‚å¯¹äºäº¤äº’å¼äº‹åŠ¡ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å‚æ•°ä¸­ä½¿ç”¨ä»¥ä¸‹å¯é€‰é…ç½®é€‰é¡¹ï¼š

-   `maxWait`ï¼šPrisma Client ä»æ•°æ®åº“è·å–äº‹åŠ¡è¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚é»˜è®¤å€¼ä¸º 2 ç§’ã€‚
-   `timeout`ï¼šäº¤äº’å¼äº‹åŠ¡åœ¨è¢«å–æ¶ˆå’Œå›æ»šä¹‹å‰å¯ä»¥è¿è¡Œçš„æœ€é•¿æ—¶é—´ã€‚é»˜è®¤å€¼ä¸º 5 ç§’ã€‚
-   `isolationLevel`ï¼šè®¾ç½®[äº‹åŠ¡éš”ç¦»çº§åˆ«](#transaction-isolation-level)ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™è¢«è®¾ç½®ä¸ºæ‚¨æ•°æ®åº“å½“å‰é…ç½®çš„å€¼ã€‚

ä¾‹å¦‚ï¼š

```ts
await prisma.$transaction(
  async (tx) => {
    // åœ¨äº‹åŠ¡ä¸­è¿è¡Œçš„ä»£ç ...
  },
  {
    maxWait: 5000, // é»˜è®¤: 2000
    timeout: 10000, // é»˜è®¤: 5000
    isolationLevel: Prisma.TransactionIsolationLevel.Serializable, // å¯é€‰ï¼Œé»˜è®¤ç”±æ•°æ®åº“é…ç½®å®šä¹‰
  }
)
```

æ‚¨ä¹Ÿå¯ä»¥åœ¨æ„é€ å‡½æ•°çº§åˆ«å…¨å±€è®¾ç½®è¿™äº›é€‰é¡¹ï¼š

```ts
const prisma = new PrismaClient({
  transactionOptions: {
    isolationLevel: Prisma.TransactionIsolationLevel.Serializable,
    maxWait: 5000, // é»˜è®¤: 2000
    timeout: 10000, // é»˜è®¤: 5000
  },
})
```

### äº‹åŠ¡éš”ç¦»çº§åˆ« (Transaction isolation level)

<Admonition type="info">

æ­¤åŠŸèƒ½åœ¨ MongoDB ä¸Šä¸å¯ç”¨ï¼Œå› ä¸º MongoDB ä¸æ”¯æŒéš”ç¦»çº§åˆ«ã€‚

</Admonition>

æ‚¨å¯ä»¥ä¸ºäº‹åŠ¡è®¾ç½®äº‹åŠ¡[éš”ç¦»çº§åˆ«](https://www.prisma.io/dataguide/intro/database-glossary#isolation-levels)ã€‚

<Admonition type="info">

å¯¹äºäº¤äº’å¼äº‹åŠ¡ï¼Œæ­¤åŠŸèƒ½è‡ªç‰ˆæœ¬ 4.2.0 èµ·å¯ç”¨ï¼›å¯¹äºé¡ºåºæ“ä½œï¼Œè‡ªç‰ˆæœ¬ 4.4.0 èµ·å¯ç”¨ã€‚

åœ¨ 4.2.0ï¼ˆå¯¹äºäº¤äº’å¼äº‹åŠ¡ï¼‰æˆ– 4.4.0ï¼ˆå¯¹äºé¡ºåºæ“ä½œï¼‰ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ‚¨æ— æ³•åœ¨ Prisma ORM çº§åˆ«é…ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚Prisma ORM ä¸ä¼šæ˜¾å¼è®¾ç½®éš”ç¦»çº§åˆ«ï¼Œå› æ­¤ä½¿ç”¨[æ‚¨æ•°æ®åº“ä¸­é…ç½®çš„éš”ç¦»çº§åˆ«](#database-specific-information-on-isolation-levels)ã€‚

</Admonition>

#### è®¾ç½®éš”ç¦»çº§åˆ«

è¦è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œè¯·åœ¨ API çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­ä½¿ç”¨ `isolationLevel` é€‰é¡¹ã€‚

å¯¹äºé¡ºåºæ“ä½œï¼š

```ts
await prisma.$transaction(
  [
    // åœ¨äº‹åŠ¡ä¸­è¿è¡Œçš„ Prisma Client æ“ä½œ...
  ],
  {
    isolationLevel: Prisma.TransactionIsolationLevel.Serializable, // å¯é€‰ï¼Œé»˜è®¤ç”±æ•°æ®åº“é…ç½®å®šä¹‰
  }
)
```

å¯¹äºäº¤äº’å¼äº‹åŠ¡ï¼š

```jsx
await prisma.$transaction(
  async (prisma) => {
    // åœ¨äº‹åŠ¡ä¸­è¿è¡Œçš„ä»£ç ...
  },
  {
    isolationLevel: Prisma.TransactionIsolationLevel.Serializable, // å¯é€‰ï¼Œé»˜è®¤ç”±æ•°æ®åº“é…ç½®å®šä¹‰
    maxWait: 5000, // é»˜è®¤: 2000
    timeout: 10000, // é»˜è®¤: 5000
  }
)
```

#### æ”¯æŒçš„éš”ç¦»çº§åˆ«

å¦‚æœåº•å±‚æ•°æ®åº“æ”¯æŒï¼ŒPrisma Client æ”¯æŒä»¥ä¸‹éš”ç¦»çº§åˆ«ï¼š

-   `ReadUncommitted`ï¼ˆè¯»æœªæäº¤ï¼‰
-   `ReadCommitted`ï¼ˆè¯»å·²æäº¤ï¼‰
-   `RepeatableRead`ï¼ˆå¯é‡å¤è¯»ï¼‰
-   `Snapshot`ï¼ˆå¿«ç…§ï¼‰
-   `Serializable`ï¼ˆä¸²è¡ŒåŒ–ï¼‰

æ¯ä¸ªæ•°æ®åº“è¿æ¥å™¨å¯ç”¨çš„éš”ç¦»çº§åˆ«å¦‚ä¸‹ï¼š

| æ•°æ®åº“      | `ReadUncommitted` | `ReadCommitted` | `RepeatableRead` | `Snapshot` | `Serializable` |
| ----------- | ----------------- | --------------- | ---------------- | ---------- | -------------- |
| PostgreSQL  | âœ”ï¸                | âœ”ï¸              | âœ”ï¸               | å¦         | âœ”ï¸             |
| MySQL       | âœ”ï¸                | âœ”ï¸              | âœ”ï¸               | å¦         | âœ”ï¸             |
| SQL Server  | âœ”ï¸                | âœ”ï¸              | âœ”ï¸               | âœ”ï¸         | âœ”ï¸             |
| CockroachDB | å¦                | å¦              | å¦               | å¦         | âœ”ï¸             |
| SQLite      | å¦                | å¦              | å¦               | å¦         | âœ”ï¸             |

é»˜è®¤æƒ…å†µä¸‹ï¼ŒPrisma Client å°†éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºæ‚¨æ•°æ®åº“å½“å‰é…ç½®çš„å€¼ã€‚

æ¯ä¸ªæ•°æ®åº“é»˜è®¤é…ç½®çš„éš”ç¦»çº§åˆ«å¦‚ä¸‹ï¼š

| æ•°æ®åº“      | é»˜è®¤             |
| ----------- | ---------------- |
| PostgreSQL  | `ReadCommitted`  |
| MySQL       | `RepeatableRead` |
| SQL Server  | `ReadCommitted`  |
| CockroachDB | `Serializable`   |
| SQLite      | `Serializable`   |

#### å…³äºéš”ç¦»çº§åˆ«çš„æ•°æ®åº“ç‰¹å®šä¿¡æ¯

è¯·å‚é˜…ä»¥ä¸‹èµ„æºï¼š

-   [PostgreSQL ä¸­çš„äº‹åŠ¡éš”ç¦»çº§åˆ«](https://www.postgresql.org/docs/9.3/runtime-config-client.html#GUC-DEFAULT-TRANSACTION-ISOLATION)
-   [Microsoft SQL Server ä¸­çš„äº‹åŠ¡éš”ç¦»çº§åˆ«](https://learn.microsoft.com/zh-cn/sql/t-sql/statements/set-transaction-isolation-level-transact-sql?view=sql-server-ver15)
-   [MySQL ä¸­çš„äº‹åŠ¡éš”ç¦»çº§åˆ«](https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html)

CockroachDB å’Œ SQLite ä»…æ”¯æŒ `Serializable` éš”ç¦»çº§åˆ«ã€‚

### äº‹åŠ¡æ—¶åºé—®é¢˜ (Transaction timing issues)

<Admonition type="info">

-   æœ¬èŠ‚ä¸­çš„è§£å†³æ–¹æ¡ˆä¸é€‚ç”¨äº MongoDBï¼Œå› ä¸º MongoDB ä¸æ”¯æŒ[éš”ç¦»çº§åˆ«](https://www.prisma.io/dataguide/intro/database-glossary#isolation-levels)ã€‚
-   æœ¬èŠ‚è®¨è®ºçš„æ—¶åºé—®é¢˜ä¸é€‚ç”¨äº CockroachDB å’Œ SQLiteï¼Œå› ä¸ºè¿™äº›æ•°æ®åº“ä»…æ”¯æŒæœ€é«˜çš„ `Serializable` éš”ç¦»çº§åˆ«ã€‚

</Admonition>

å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åœ¨æŸäº›[éš”ç¦»çº§åˆ«](https://www.prisma.io/dataguide/intro/database-glossary#isolation-levels)ä¸‹å¹¶å‘è¿è¡Œæ—¶ï¼Œæ—¶åºé—®é¢˜å¯èƒ½å¯¼è‡´å†™å…¥å†²çªæˆ–æ­»é”ï¼Œä¾‹å¦‚è¿åå”¯ä¸€çº¦æŸã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹äº‹ä»¶åºåˆ—ï¼Œå…¶ä¸­äº‹åŠ¡ A å’Œäº‹åŠ¡ B éƒ½å°è¯•æ‰§è¡Œ `deleteMany` å’Œ `createMany` æ“ä½œï¼š

1.  äº‹åŠ¡ Bï¼š`createMany` æ“ä½œåˆ›å»ºä¸€ç»„æ–°è¡Œã€‚
2.  äº‹åŠ¡ Bï¼šåº”ç”¨ç¨‹åºæäº¤äº‹åŠ¡ Bã€‚
3.  äº‹åŠ¡ Aï¼š`createMany` æ“ä½œã€‚
4.  äº‹åŠ¡ Aï¼šåº”ç”¨ç¨‹åºæäº¤äº‹åŠ¡ Aã€‚æ–°è¡Œä¸äº‹åŠ¡ B åœ¨æ­¥éª¤ 2 ä¸­æ·»åŠ çš„è¡Œå‘ç”Ÿå†²çªã€‚

è¿™ç§å†²çªå¯èƒ½å‘ç”Ÿåœ¨ `ReadCommitted` éš”ç¦»çº§åˆ«ï¼Œè¿™æ˜¯ PostgreSQL å’Œ Microsoft SQL Server ä¸­çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨å¯ä»¥è®¾ç½®æ›´é«˜çš„éš”ç¦»çº§åˆ«ï¼ˆ`RepeatableRead` æˆ– `Serializable`ï¼‰ã€‚æ‚¨å¯ä»¥åœ¨äº‹åŠ¡ä¸Šè®¾ç½®éš”ç¦»çº§åˆ«ã€‚è¿™å°†è¦†ç›–è¯¥äº‹åŠ¡çš„æ•°æ®åº“éš”ç¦»çº§åˆ«ã€‚

è¦é¿å…äº‹åŠ¡å†™å…¥å†²çªå’Œæ­»é”ï¼š

1.  åœ¨æ‚¨çš„äº‹åŠ¡ä¸Šï¼Œä½¿ç”¨ `isolationLevel` å‚æ•°è®¾ç½®ä¸º `Prisma.TransactionIsolationLevel.Serializable`ã€‚

    è¿™ç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºæäº¤å¤šä¸ªå¹¶å‘æˆ–å¹¶è¡Œäº‹åŠ¡æ—¶ï¼Œå…¶æ•ˆæœå¦‚åŒå®ƒä»¬æ˜¯ä¸²è¡Œè¿è¡Œä¸€æ ·ã€‚å½“äº‹åŠ¡å› å†™å…¥å†²çªæˆ–æ­»é”è€Œå¤±è´¥æ—¶ï¼ŒPrisma Client è¿”å› [P2034 é”™è¯¯](/orm/reference/error-reference#p2034)ã€‚

2.  åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä»£ç ä¸­ï¼Œå›´ç»•æ‚¨çš„äº‹åŠ¡æ·»åŠ é‡è¯•é€»è¾‘ä»¥å¤„ç†ä»»ä½• P2034 é”™è¯¯ï¼Œå¦‚æ­¤ç¤ºä¾‹æ‰€ç¤ºï¼š

    ```ts
    import { Prisma, PrismaClient } from '@prisma/client'

    const prisma = new PrismaClient()
    async function main() {
      const MAX_RETRIES = 5
      let retries = 0

      let result
      while (retries < MAX_RETRIES) {
        try {
          result = await prisma.$transaction(
            [
              prisma.user.deleteMany({
                where: {
                  /** args */
                },
              }),
              prisma.post.createMany({
                data: {
                  /** args */
                },
              }),
            ],
            {
              isolationLevel: Prisma.TransactionIsolationLevel.Serializable,
            }
          )
          break // æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
        } catch (error) {
          if (error.code === 'P2034') { // æ£€æŸ¥æ˜¯å¦ä¸ºäº‹åŠ¡å†²çªé”™è¯¯
            retries++ // å¢åŠ é‡è¯•æ¬¡æ•°
            continue // ç»§ç»­ä¸‹ä¸€æ¬¡å°è¯•
          }
          throw error // å¦‚æœæ˜¯å…¶ä»–é”™è¯¯ï¼Œåˆ™æŠ›å‡º
        }
      }
      // å¯é€‰ï¼šå¤„ç†è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åçš„æƒ…å†µ
      if (retries === MAX_RETRIES) {
        console.error('äº‹åŠ¡å› å†²çªé‡è¯•å¤šæ¬¡åä»ç„¶å¤±è´¥ã€‚')
        // æ ¹æ®éœ€è¦å¤„ç†å¤±è´¥æƒ…å†µ
      }
    }
    ```

### åœ¨ `Promise.all()` ä¸­ä½¿ç”¨ `$transaction`

å¦‚æœæ‚¨å°† `$transaction` åŒ…è£…åœ¨å¯¹ `Promise.all()` çš„è°ƒç”¨ä¸­ï¼Œäº‹åŠ¡å†…çš„æŸ¥è¯¢å°†æŒ‰*é¡ºåº*æ‰§è¡Œï¼ˆå³ä¸€ä¸ªæ¥ä¸€ä¸ªï¼‰ï¼š

```ts
await prisma.$transaction(async (prisma) => {
  await Promise.all([
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
    prisma.user.findMany(),
  ])
})
```

è¿™å¯èƒ½ä¸ç›´è§‰ç›¸åï¼Œå› ä¸º `Promise.all()` é€šå¸¸ä¼š*å¹¶è¡ŒåŒ–*ä¼ é€’ç»™å®ƒçš„è°ƒç”¨ã€‚

è¿™ç§è¡Œä¸ºçš„åŸå› æ˜¯ï¼š
- ä¸€ä¸ªäº‹åŠ¡æ„å‘³ç€å…¶ä¸­çš„æ‰€æœ‰æŸ¥è¯¢éƒ½å¿…é¡»åœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šè¿è¡Œã€‚
- ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ã€‚
- ç”±äºä¸€ä¸ªæŸ¥è¯¢åœ¨å·¥ä½œæ—¶ä¼šé˜»å¡è¿æ¥ï¼Œå°†äº‹åŠ¡æ”¾å…¥ `Promise.all` å®é™…ä¸Šæ„å‘³ç€æŸ¥è¯¢åº”è¯¥ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿è¡Œã€‚


## ä¾èµ–å†™å…¥ (Dependent writes)

å†™å…¥è¢«è®¤ä¸ºæ˜¯**ç›¸äº’ä¾èµ–**çš„ï¼Œå¦‚æœï¼š

-   æ“ä½œä¾èµ–äºå…ˆå‰æ“ä½œçš„ç»“æœï¼ˆä¾‹å¦‚ï¼Œæ•°æ®åº“ç”Ÿæˆ IDï¼‰

æœ€å¸¸è§çš„åœºæ™¯æ˜¯åˆ›å»ºä¸€ä¸ªè®°å½•å¹¶ä½¿ç”¨ç”Ÿæˆçš„ ID æ¥åˆ›å»ºæˆ–æ›´æ–°ç›¸å…³è®°å½•ã€‚ç¤ºä¾‹åŒ…æ‹¬ï¼š

-   åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’Œä¸¤ç¯‡ç›¸å…³çš„åšå®¢æ–‡ç« ï¼ˆä¸€å¯¹å¤šå…³ç³»ï¼‰- åœ¨åˆ›å»ºåšå®¢æ–‡ç« ä¹‹å‰å¿…é¡»çŸ¥é“ä½œè€… ID
-   åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿå¹¶åˆ†é…æˆå‘˜ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰- åœ¨åˆ†é…æˆå‘˜ä¹‹å‰å¿…é¡»çŸ¥é“å›¢é˜Ÿ ID

ä¾èµ–å†™å…¥å¿…é¡»ä¸€èµ·æˆåŠŸæ‰èƒ½ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§å¹¶é˜²æ­¢æ„å¤–è¡Œä¸ºï¼Œä¾‹å¦‚æ²¡æœ‰ä½œè€…çš„åšå®¢æ–‡ç« æˆ–æ²¡æœ‰æˆå‘˜çš„å›¢é˜Ÿã€‚

### åµŒå¥—å†™å…¥ (Nested writes)

Prisma Client å¯¹ä¾èµ–å†™å…¥çš„è§£å†³æ–¹æ¡ˆæ˜¯**åµŒå¥—å†™å…¥**åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½ç”± `create` å’Œ `update` æ”¯æŒã€‚ä»¥ä¸‹åµŒå¥—å†™å…¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’Œä¸¤ç¯‡åšå®¢æ–‡ç« ï¼š

```ts
const nestedWrite = await prisma.user.create({
  data: {
    email: 'imani@prisma.io',
    posts: {
      create: [
        { title: 'æˆ‘åœ¨ Prisma çš„ç¬¬ä¸€å¤©' },
        { title: 'å¦‚ä½•åœ¨ PostgreSQL ä¸­é…ç½®å”¯ä¸€çº¦æŸ' },
      ],
    },
  },
})
```

å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒPrisma Client å°†å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚åµŒå¥—å†™å…¥ç›®å‰ä¸å—é¡¶çº§æ‰¹é‡æ“ä½œï¼ˆå¦‚ `client.user.deleteMany` å’Œ `client.user.updateMany`ï¼‰çš„æ”¯æŒã€‚

#### ä½•æ—¶ä½¿ç”¨åµŒå¥—å†™å…¥

å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œè¯·è€ƒè™‘ä½¿ç”¨åµŒå¥—å†™å…¥ï¼š

-   âœ” æ‚¨æƒ³åŒæ—¶åˆ›å»ºä¸¤ä¸ªæˆ–å¤šä¸ªé€šè¿‡ ID å…³è”çš„è®°å½•ï¼ˆä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ç¯‡åšå®¢æ–‡ç« å’Œä¸€ä¸ªç”¨æˆ·ï¼‰
-   âœ” æ‚¨æƒ³åŒæ—¶æ›´æ–°å’Œåˆ›å»ºé€šè¿‡ ID å…³è”çš„è®°å½•ï¼ˆä¾‹å¦‚ï¼Œæ›´æ”¹ç”¨æˆ·åç§°å¹¶åˆ›å»ºä¸€ç¯‡æ–°çš„åšå®¢æ–‡ç« ï¼‰

:::tip

å¦‚æœæ‚¨[é¢„å…ˆè®¡ç®—æ‚¨çš„ IDï¼Œæ‚¨å¯ä»¥åœ¨åµŒå¥—å†™å…¥æˆ–ä½¿ç”¨ `$transaction([])` API ä¹‹é—´è¿›è¡Œé€‰æ‹©](#scenario-pre-computed-ids-and-the-transaction-api)ã€‚

:::

#### åœºæ™¯ï¼šæ³¨å†Œæµç¨‹

è€ƒè™‘ Slack çš„æ³¨å†Œæµç¨‹ï¼Œè¯¥æµç¨‹ï¼š

1.  åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿ
2.  å‘è¯¥å›¢é˜Ÿæ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·è‡ªåŠ¨æˆä¸ºè¯¥å›¢é˜Ÿçš„ç®¡ç†å‘˜

è¿™ä¸ªåœºæ™¯å¯ä»¥ç”¨ä»¥ä¸‹ schema è¡¨ç¤º - è¯·æ³¨æ„ï¼Œç”¨æˆ·å¯ä»¥å±äºå¤šä¸ªå›¢é˜Ÿï¼Œå›¢é˜Ÿå¯ä»¥æœ‰å¤šä¸ªç”¨æˆ·ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰ï¼š

```prisma
model Team {
  id      Int    @id @default(autoincrement())
  name    String
  members User[] // å¤šä¸ªå›¢é˜Ÿæˆå‘˜
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  teams Team[] // å¤šä¸ªå›¢é˜Ÿ
}
```

æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿï¼Œç„¶ååˆ›å»ºå¹¶å°†ç”¨æˆ·é™„åŠ åˆ°è¯¥å›¢é˜Ÿï¼š

```ts
// åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿ
const team = await prisma.team.create({
  data: {
    name: 'Aurora Adventures',
  },
})

// åˆ›å»ºä¸€ä¸ªç”¨æˆ·å¹¶å°†å…¶åˆ†é…ç»™å›¢é˜Ÿ
const user = await prisma.user.create({
  data: {
    email: 'alice@prisma.io',
    teams: { // 'teams' è€Œä¸æ˜¯ 'team'ï¼Œå› ä¸ºæ˜¯å¤šå¯¹å¤šå…³ç³»
      connect: {
        id: team.id,
      },
    },
  },
})
```

ç„¶è€Œï¼Œè¿™æ®µä»£ç å­˜åœ¨ä¸€ä¸ªé—®é¢˜ - è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼š

1.  åˆ›å»ºå›¢é˜ŸæˆåŠŸ - "Aurora Adventures" ç°åœ¨å·²è¢«å ç”¨
2.  åˆ›å»ºå’Œè¿æ¥ç”¨æˆ·å¤±è´¥ - å›¢é˜Ÿ "Aurora Adventures" å­˜åœ¨ï¼Œä½†æ²¡æœ‰ç”¨æˆ·
3.  å†æ¬¡é€šè¿‡æ³¨å†Œæµç¨‹å¹¶å°è¯•é‡æ–°åˆ›å»º "Aurora Adventures" å¤±è´¥ - è¯¥å›¢é˜Ÿå·²å­˜åœ¨

åˆ›å»ºå›¢é˜Ÿå’Œæ·»åŠ ç”¨æˆ·åº”è¯¥æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œ**è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥**ã€‚

è¦åœ¨ä½çº§æ•°æ®åº“å®¢æˆ·ç«¯ä¸­å®ç°åŸå­å†™å…¥ï¼Œæ‚¨å¿…é¡»å°†æ’å…¥æ“ä½œåŒ…è£…åœ¨ `BEGIN`ã€`COMMIT` å’Œ `ROLLBACK` è¯­å¥ä¸­ã€‚Prisma Client é€šè¿‡[åµŒå¥—å†™å…¥](/orm/prisma-client/queries/relation-queries#nested-writes)è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä»¥ä¸‹æŸ¥è¯¢åœ¨å•ä¸ªäº‹åŠ¡ä¸­åˆ›å»ºå›¢é˜Ÿã€åˆ›å»ºç”¨æˆ·å¹¶è¿æ¥è®°å½•ï¼š

```ts
const team = await prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      create: {
        email: 'alice@prisma.io',
      },
    },
  },
})
```

æ­¤å¤–ï¼Œå¦‚æœåœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿé”™è¯¯ï¼ŒPrisma Client éƒ½ä¼šå›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚

#### åµŒå¥—å†™å…¥å¸¸è§é—®é¢˜è§£ç­”

##### ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½ä½¿ç”¨ `$transaction([])` API æ¥è§£å†³åŒæ ·çš„é—®é¢˜ï¼Ÿ

`$transaction([])` API ä¸å…è®¸æ‚¨åœ¨ä¸åŒçš„æ“ä½œä¹‹é—´ä¼ é€’ IDã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œ`createUserOperation.id` å°šä¸å¯ç”¨ï¼š

```ts highlight=12;delete
const createUserOperation = prisma.user.create({
  data: {
    email: 'ebony@prisma.io',
  },
})

const createTeamOperation = prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      connect: {
        //delete-next-line
        id: createUserOperation.id, // ä¸å¯èƒ½ï¼ŒID å°šä¸å¯ç”¨
      },
    },
  },
})

await prisma.$transaction([createUserOperation, createTeamOperation])
```

##### åµŒå¥—å†™å…¥æ”¯æŒåµŒå¥—æ›´æ–°ï¼Œä½†æ›´æ–°ä¸æ˜¯ä¾èµ–å†™å…¥ - æˆ‘åº”è¯¥ä½¿ç”¨ `$transaction([])` API å—ï¼Ÿ

æ˜¯çš„ï¼Œå¯ä»¥è¯´å› ä¸ºæ‚¨çŸ¥é“å›¢é˜Ÿçš„ IDï¼Œæ‚¨å¯ä»¥åœ¨ `$transaction([])` ä¸­ç‹¬ç«‹åœ°æ›´æ–°å›¢é˜ŸåŠå…¶å›¢é˜Ÿæˆå‘˜ã€‚ä»¥ä¸‹ç¤ºä¾‹åœ¨ `$transaction([])` ä¸­æ‰§è¡Œè¿™ä¸¤ä¸ªæ“ä½œï¼š

```ts
const updateTeam = prisma.team.update({
  where: {
    id: 1,
  },
  data: {
    name: 'Aurora Adventures Ltd',
  },
})

const updateUsers = prisma.user.updateMany({
  where: {
    teams: {
      some: {
        id: 1,
      },
    },
    name: { // å‡è®¾ User æ¨¡å‹æœ‰ 'name' å­—æ®µ
      equals: null,
    },
  },
  data: {
    name: 'Unknown User',
  },
})

await prisma.$transaction([updateUsers, updateTeam])
```

ç„¶è€Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åµŒå¥—å†™å…¥è¾¾åˆ°ç›¸åŒçš„ç»“æœï¼š

```ts
const updateTeam = await prisma.team.update({
  where: {
    id: 1,
  },
  data: {
    name: 'Aurora Adventures Ltd', // æ›´æ–°å›¢é˜Ÿåç§°
    members: {
      updateMany: {
        // æ›´æ–°æ²¡æœ‰åç§°çš„å›¢é˜Ÿæˆå‘˜
        data: {
          name: 'Unknown User',
        },
        where: {
          name: {
            equals: null,
          },
        },
      },
    },
  },
})
```

##### æˆ‘å¯ä»¥æ‰§è¡Œå¤šä¸ªåµŒå¥—å†™å…¥å— - ä¾‹å¦‚ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°å›¢é˜Ÿå¹¶åˆ†é…ç”¨æˆ·ï¼Ÿ

æ˜¯çš„ï¼Œä½†è¿™æ˜¯åœºæ™¯å’ŒæŠ€æœ¯çš„ç»„åˆï¼š

-   åˆ›å»ºå›¢é˜Ÿå¹¶åˆ†é…ç”¨æˆ·æ˜¯ä¾èµ–å†™å…¥ - ä½¿ç”¨åµŒå¥—å†™å…¥
-   åŒæ—¶åˆ›å»ºæ‰€æœ‰å›¢é˜Ÿå’Œç”¨æˆ·æ˜¯ç‹¬ç«‹å†™å…¥ï¼Œå› ä¸ºå›¢é˜Ÿ/ç”¨æˆ·ç»„åˆ #1 å’Œå›¢é˜Ÿ/ç”¨æˆ·ç»„åˆ #2 æ˜¯ä¸ç›¸å…³çš„å†™å…¥ - ä½¿ç”¨ `$transaction([])` API

```ts
// åµŒå¥—å†™å…¥
const createOne = prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      create: {
        email: 'alice@prisma.io',
      },
    },
  },
})

// åµŒå¥—å†™å…¥
const createTwo = prisma.team.create({
  data: {
    name: 'Cool Crew',
    members: {
      create: {
        email: 'elsa@prisma.io',
      },
    },
  },
})

// $transaction([]) API
await prisma.$transaction([createTwo, createOne])
```

## ç‹¬ç«‹å†™å…¥ (Independent writes)

å¦‚æœå†™å…¥ä¸ä¾èµ–äºå…ˆå‰æ“ä½œçš„ç»“æœï¼Œåˆ™å®ƒä»¬è¢«è®¤ä¸ºæ˜¯**ç‹¬ç«‹çš„**ã€‚ä»¥ä¸‹ç‹¬ç«‹å†™å…¥ç»„å¯ä»¥æŒ‰ä»»ä½•é¡ºåºå‘ç”Ÿï¼š

-   å°†è®¢å•åˆ—è¡¨çš„çŠ¶æ€å­—æ®µæ›´æ–°ä¸ºâ€œå·²å‘è´§â€
-   å°†ç”µå­é‚®ä»¶åˆ—è¡¨æ ‡è®°ä¸ºâ€œå·²è¯»â€

> **æ³¨æ„**: å¦‚æœå­˜åœ¨çº¦æŸï¼Œç‹¬ç«‹å†™å…¥å¯èƒ½å¿…é¡»æŒ‰ç‰¹å®šé¡ºåºè¿›è¡Œ - ä¾‹å¦‚ï¼Œå¦‚æœå¸–å­å…·æœ‰å¼ºåˆ¶æ€§çš„ `authorId` å­—æ®µï¼Œåˆ™å¿…é¡»åœ¨åšå®¢ä½œè€…ä¹‹å‰åˆ é™¤åšå®¢æ–‡ç« ã€‚ç„¶è€Œï¼Œå®ƒä»¬ä»ç„¶è¢«è®¤ä¸ºæ˜¯ç‹¬ç«‹å†™å…¥ï¼Œå› ä¸ºæ²¡æœ‰æ“ä½œä¾èµ–äºå…ˆå‰æ“ä½œçš„*ç»“æœ*ï¼Œä¾‹å¦‚æ•°æ®åº“è¿”å›ç”Ÿæˆçš„ IDã€‚

æ ¹æ®æ‚¨çš„è¦æ±‚ï¼ŒPrisma Client æœ‰å››ç§é€‰é¡¹æ¥å¤„ç†åº”ä¸€èµ·æˆåŠŸæˆ–å¤±è´¥çš„ç‹¬ç«‹å†™å…¥ã€‚

### æ‰¹é‡æ“ä½œ (Bulk operations)

æ‰¹é‡å†™å…¥å…è®¸æ‚¨åœ¨å•ä¸ªäº‹åŠ¡ä¸­å†™å…¥ç›¸åŒç±»å‹çš„å¤šä¸ªè®°å½• - å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒPrisma Client å°†å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚Prisma Client ç›®å‰æ”¯æŒï¼š

-   `createMany()`
-   `createManyAndReturn()`
-   `updateMany()`
-   `updateManyAndReturn()`
-   `deleteMany()`


#### ä½•æ—¶ä½¿ç”¨æ‰¹é‡æ“ä½œ

å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œè¯·è€ƒè™‘å°†æ‰¹é‡æ“ä½œä½œä¸ºè§£å†³æ–¹æ¡ˆï¼š

-   âœ” æ‚¨æƒ³æ›´æ–°ä¸€æ‰¹*ç›¸åŒç±»å‹*çš„è®°å½•ï¼Œä¾‹å¦‚ä¸€æ‰¹ç”µå­é‚®ä»¶

#### åœºæ™¯ï¼šå°†ç”µå­é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»

æ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªç±»ä¼¼ gmail.com çš„æœåŠ¡ï¼Œæ‚¨çš„å®¢æˆ·æƒ³è¦ä¸€ä¸ª**â€œæ ‡è®°ä¸ºå·²è¯»â€**çš„åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·å°†æ‰€æœ‰ç”µå­é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»ã€‚æ¯æ¬¡å¯¹ç”µå­é‚®ä»¶çŠ¶æ€çš„æ›´æ–°éƒ½æ˜¯ä¸€æ¬¡ç‹¬ç«‹å†™å…¥ï¼Œå› ä¸ºç”µå­é‚®ä»¶ä¹‹é—´ä¸ç›¸äº’ä¾èµ– - ä¾‹å¦‚ï¼Œæ‚¨é˜¿å§¨å‘æ¥çš„â€œç”Ÿæ—¥å¿«ä¹ï¼ğŸ°â€ç”µå­é‚®ä»¶ä¸å®œå®¶å‘æ¥çš„ä¿ƒé”€ç”µå­é‚®ä»¶æ— å…³ã€‚

åœ¨ä»¥ä¸‹ schema ä¸­ï¼Œä¸€ä¸ª `User` å¯ä»¥æœ‰è®¸å¤šæ”¶åˆ°çš„ç”µå­é‚®ä»¶ï¼ˆä¸€å¯¹å¤šå…³ç³»ï¼‰ï¼š

```ts
model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  receivedEmails  Email[]   // è®¸å¤šç”µå­é‚®ä»¶
}

model Email {
  id      Int     @id @default(autoincrement())
  user    User    @relation(fields: [userId], references: [id])
  userId  Int
  subject String
  body    String
  unread  Boolean @default(true) // æ·»åŠ é»˜è®¤å€¼å¯èƒ½æ›´æœ‰ç”¨
}
```

åŸºäºæ­¤ schemaï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `updateMany` å°†æ‰€æœ‰æœªè¯»ç”µå­é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»ï¼š

```ts
const userIdToUpdate = 10; // å‡è®¾è¦æ›´æ–°ç”¨æˆ· ID ä¸º 10 çš„é‚®ä»¶

await prisma.email.updateMany({
  where: {
    userId: userIdToUpdate, // ä½¿ç”¨ userId è¿‡æ»¤
    unread: true,
  },
  data: {
    unread: false,
  },
})
```

#### æˆ‘å¯ä»¥å°†åµŒå¥—å†™å…¥ä¸æ‰¹é‡æ“ä½œä¸€èµ·ä½¿ç”¨å—ï¼Ÿ

ä¸å¯ä»¥ - `updateMany` å’Œ `deleteMany` ç›®å‰éƒ½ä¸æ”¯æŒåµŒå¥—å†™å…¥ã€‚ä¾‹å¦‚ï¼Œæ‚¨ä¸èƒ½åˆ é™¤å¤šä¸ªå›¢é˜ŸåŠå…¶æ‰€æœ‰æˆå‘˜ï¼ˆçº§è”åˆ é™¤ï¼‰ï¼š

```ts highlight=8;delete
await prisma.team.deleteMany({
  where: {
    id: {
      in: [2, 99, 2, 11],
    },
  },
  //delete-next-line
  // data: { members: {} }, // æ­¤å¤„æ— æ³•è®¿é—®æˆå‘˜
})
```

#### æˆ‘å¯ä»¥å°†æ‰¹é‡æ“ä½œä¸ `$transaction([])` API ä¸€èµ·ä½¿ç”¨å—ï¼Ÿ

æ˜¯çš„ â€” ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨ `$transaction([])` ä¸­åŒ…å«å¤šä¸ª `deleteMany` æ“ä½œã€‚

### `$transaction([])` API

`$transaction([])` API æ˜¯ç‹¬ç«‹å†™å…¥çš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œå…è®¸æ‚¨å°†å¤šä¸ªæ“ä½œä½œä¸ºå•ä¸ªåŸå­æ“ä½œè¿è¡Œ - å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒPrisma Client å°†å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚

è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ“ä½œæ˜¯æŒ‰ç…§å®ƒä»¬åœ¨äº‹åŠ¡ä¸­æ”¾ç½®çš„é¡ºåºæ‰§è¡Œçš„ã€‚

```ts
await prisma.$transaction([iRunFirst, iRunSecond, iRunThird])
```

> **æ³¨æ„**: åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨æŸ¥è¯¢ä¸ä¼šå½±å“æŸ¥è¯¢æœ¬èº«å†…éƒ¨æ“ä½œçš„é¡ºåºã€‚

éšç€ Prisma Client çš„å‘å±•ï¼Œ`$transaction([])` API çš„ç”¨ä¾‹å°†è¶Šæ¥è¶Šå¤šåœ°è¢«æ›´ä¸“é—¨çš„æ‰¹é‡æ“ä½œï¼ˆå¦‚ `createMany`ï¼‰å’ŒåµŒå¥—å†™å…¥æ‰€å–ä»£ã€‚

#### ä½•æ—¶ä½¿ç”¨ `$transaction([])` API

å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ `$transaction([])` APIï¼š

-   âœ” æ‚¨æƒ³æ›´æ–°ä¸€ä¸ªåŒ…å«ä¸åŒç±»å‹è®°å½•çš„æ‰¹æ¬¡ï¼Œä¾‹å¦‚ç”µå­é‚®ä»¶å’Œç”¨æˆ·ã€‚è¿™äº›è®°å½•ä¸éœ€è¦ä»¥ä»»ä½•æ–¹å¼ç›¸å…³è”ã€‚
-   âœ” æ‚¨æƒ³æ‰¹é‡å¤„ç†åŸå§‹ SQL æŸ¥è¯¢ (`$executeRaw`) - ä¾‹å¦‚ï¼Œå¯¹äº Prisma Client å°šä¸æ”¯æŒçš„åŠŸèƒ½ã€‚

#### åœºæ™¯ï¼šéšç§æ³•è§„

GDPR å’Œå…¶ä»–éšç§æ³•è§„èµ‹äºˆç”¨æˆ·è¦æ±‚ç»„ç»‡åˆ é™¤å…¶æ‰€æœ‰ä¸ªäººæ•°æ®çš„æƒåˆ©ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ schema ä¸­ï¼Œä¸€ä¸ª `User` å¯ä»¥æœ‰è®¸å¤šå¸–å­å’Œç§ä¿¡ï¼š

```prisma
model User {
  id              Int              @id @default(autoincrement())
  posts           Post[]
  privateMessages PrivateMessage[]
}

model Post {
  id      Int    @id @default(autoincrement())
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade) // æ·»åŠ  onDelete: Cascade å¯ä»¥ç®€åŒ–åˆ é™¤
  userId  Int
  title   String
  content String
}

model PrivateMessage {
  id      Int    @id @default(autoincrement())
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade) // æ·»åŠ  onDelete: Cascade
  userId  Int
  message String
}
```

å¦‚æœç”¨æˆ·è°ƒç”¨è¢«é—å¿˜æƒï¼Œæˆ‘ä»¬å¿…é¡»åˆ é™¤ä¸‰ä¸ªè®°å½•ï¼šç”¨æˆ·è®°å½•ã€ç§ä¿¡å’Œå¸–å­ã€‚è‡³å…³é‡è¦çš„æ˜¯ï¼Œ*æ‰€æœ‰*åˆ é™¤æ“ä½œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆæ ¹æœ¬ä¸æˆåŠŸï¼Œè¿™ä½¿å…¶æˆä¸ºäº‹åŠ¡çš„ç”¨ä¾‹ã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨å•ä¸ªæ‰¹é‡æ“ä½œï¼ˆå¦‚ `deleteMany`ï¼‰æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è·¨ä¸‰ä¸ªæ¨¡å‹è¿›è¡Œåˆ é™¤ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `$transaction([])` API å°†ä¸‰ä¸ªæ“ä½œä¸€èµ·è¿è¡Œ - ä¸¤ä¸ª `deleteMany` å’Œä¸€ä¸ª `delete`ï¼š

```ts
const id = 9 // è¦åˆ é™¤çš„ç”¨æˆ·

// æ³¨æ„ï¼šå¦‚æœ schema ä¸­è®¾ç½®äº† onDelete: Cascadeï¼Œåˆ™åªéœ€åˆ é™¤ç”¨æˆ·å³å¯
// å¦åˆ™ï¼Œéœ€è¦æŒ‰ä»¥ä¸‹é¡ºåºåˆ é™¤

const deletePosts = prisma.post.deleteMany({
  where: {
    userId: id,
  },
})

const deleteMessages = prisma.privateMessage.deleteMany({
  where: {
    userId: id,
  },
})

const deleteUser = prisma.user.delete({
  where: {
    id: id,
  },
})

// æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
// å¦‚æœè®¾ç½®äº†çº§è”åˆ é™¤ï¼Œåªéœ€è¦ prisma.$transaction([deleteUser])
await prisma.$transaction([deletePosts, deleteMessages, deleteUser])
```

#### åœºæ™¯ï¼šé¢„è®¡ç®— ID å’Œ `$transaction([])` API

`$transaction([])` API ä¸æ”¯æŒä¾èµ–å†™å…¥ - å¦‚æœæ“ä½œ A ä¾èµ–äºæ“ä½œ B ç”Ÿæˆçš„ IDï¼Œè¯·ä½¿ç”¨[åµŒå¥—å†™å…¥](#nested-writes)ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨*é¢„å…ˆè®¡ç®—*äº† IDï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ç”Ÿæˆ GUIDï¼‰ï¼Œæ‚¨çš„å†™å…¥å°±å˜æˆäº†ç‹¬ç«‹çš„ã€‚è€ƒè™‘åµŒå¥—å†™å…¥ç¤ºä¾‹ä¸­çš„æ³¨å†Œæµç¨‹ï¼š

```ts
await prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      create: {
        email: 'alice@prisma.io',
      },
    },
  },
})
```

å°† `Team` å’Œ `User` çš„ `id` å­—æ®µæ›´æ”¹ä¸º `String`ï¼ˆå¦‚æœæ‚¨ä¸æä¾›å€¼ï¼Œåˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆ UUIDï¼‰ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆ IDã€‚æ­¤ç¤ºä¾‹ä½¿ç”¨ UUIDï¼š

```prisma highlight=2,9;delete|3,10;add
model Team {
  //delete-next-line
  id      Int    @id @default(autoincrement())
  //add-next-line
  id      String @id @default(uuid())
  name    String
  members User[]
}

model User {
  //delete-next-line
  id    Int    @id @default(autoincrement())
  //add-next-line
  id    String @id @default(uuid())
  email String @unique
  teams Team[]
}
```

å°†æ³¨å†Œæµç¨‹ç¤ºä¾‹é‡æ„ä¸ºä½¿ç”¨ `$transaction([])` API è€Œä¸æ˜¯åµŒå¥—å†™å…¥ï¼š

```ts
import { v4 } from 'uuid' // æˆ–ä½¿ç”¨ crypto.randomUUID()

const teamID = v4()
const userID = v4()

await prisma.$transaction([
  prisma.user.create({ // å…ˆåˆ›å»ºç”¨æˆ·ï¼Œå› ä¸º Team å¯èƒ½éœ€è¦å…³è”å·²å­˜åœ¨çš„ç”¨æˆ·
    data: {
      id: userID,
      email: 'alice@prisma.io',
      teams: { // è¿æ¥åˆ°å°†è¦åˆ›å»ºçš„ team
        connect: {
          id: teamID,
        },
      },
    },
  }),
  prisma.team.create({ // å†åˆ›å»º team
    data: {
      id: teamID,
      name: 'Aurora Adventures',
      // å¦‚æœéœ€è¦ï¼Œåœ¨åˆ›å»º team æ—¶è¿æ¥ userï¼Œä½†è¿™å¯èƒ½æ›´é€‚åˆåµŒå¥—å†™å…¥
      // members: { connect: { id: userID }} // è¿™åœ¨ $transaction([]) ä¸­ä¸ç›´æ¥æ”¯æŒè¿™ç§ä¾èµ–
    },
  }),
  // æ³¨æ„ï¼šä¸Šé¢è¿™ç§æ–¹å¼å¯èƒ½ä»ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸º user åˆ›å»ºæ—¶å°è¯•è¿æ¥ä¸€ä¸ªå°šä¸å­˜åœ¨çš„ team idã€‚
  // æ›´å¥½çš„æ–¹å¼æ˜¯å…ˆåˆ›å»º teamï¼Œç„¶ååˆ›å»º user å¹¶è¿æ¥ã€‚
  // æˆ–è€…ï¼Œåˆ›å»º team å’Œ user åˆ†åˆ«ï¼Œç„¶ååœ¨ä¸€ä¸ªå•ç‹¬çš„ update æ“ä½œä¸­è¿æ¥å®ƒä»¬ï¼Œéƒ½åœ¨åŒä¸€ä¸ª $transaction ä¸­ã€‚
  // æœ€æ¸…æ™°çš„æ–¹å¼ä»ç„¶æ˜¯ä½¿ç”¨åµŒå¥—å†™å…¥ï¼Œå³ä½¿æ˜¯é¢„è®¡ç®— IDã€‚
])

// æ›´å¯é çš„ä½¿ç”¨ $transaction([]) å’Œé¢„è®¡ç®— ID çš„æ–¹å¼:
const teamID = v4();
const userID = v4();

await prisma.$transaction([
  prisma.team.create({
    data: {
      id: teamID,
      name: 'Aurora Adventures',
    },
  }),
  prisma.user.create({
    data: {
      id: userID,
      email: 'alice@prisma.io',
      teams: {
        connect: { id: teamID }
      }
    },
  })
]);
```

å¦‚æœæ‚¨æ›´å–œæ¬¢åµŒå¥—å†™å…¥çš„è¯­æ³•ï¼ŒæŠ€æœ¯ä¸Šæ‚¨ä»ç„¶å¯ä»¥å°†å…¶ä¸é¢„è®¡ç®— API ä¸€èµ·ä½¿ç”¨ï¼š

```ts
import { v4 } from 'uuid' // æˆ– crypto.randomUUID()

const teamID = v4()
const userID = v4()

await prisma.team.create({
  data: {
    id: teamID,
    name: 'Aurora Adventures',
    members: {
      create: {
        id: userID,
        email: 'alice@prisma.io',
        // 'teams' å…³ç³»åœ¨ User æ¨¡å‹ä¸­å®šä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦æ˜¾å¼è¿æ¥ team
        // Prisma ä¼šè‡ªåŠ¨å¤„ç†åŸºäºåµŒå¥—ç»“æ„çš„è¿æ¥
      },
    },
  },
  // å¦‚æœéœ€è¦åŒ…å« user ä¿¡æ¯ï¼Œå¯ä»¥è¿™æ ·åš
  // include: { members: true }
})
```

å¦‚æœæ‚¨å·²ç»åœ¨ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ ID å’ŒåµŒå¥—å†™å…¥ï¼Œæ²¡æœ‰ä»¤äººä¿¡æœçš„ç†ç”±åˆ‡æ¢åˆ°æ‰‹åŠ¨ç”Ÿæˆçš„ ID å’Œ `$transaction([])` APIã€‚

## è¯»å–ã€ä¿®æ”¹ã€å†™å…¥ (Read, modify, write)

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦å°†è‡ªå®šä¹‰é€»è¾‘ä½œä¸ºåŸå­æ“ä½œçš„ä¸€éƒ¨åˆ†æ¥æ‰§è¡Œ - ä¹Ÿç§°ä¸º[è¯»å–-ä¿®æ”¹-å†™å…¥æ¨¡å¼](https://en.wikipedia.org/wiki/Read%E2%80%93modify%E2%80%93write)ã€‚ä»¥ä¸‹æ˜¯è¯»å–-ä¿®æ”¹-å†™å…¥æ¨¡å¼çš„ä¸€ä¸ªç¤ºä¾‹ï¼š

-   ä»æ•°æ®åº“è¯»å–ä¸€ä¸ªå€¼
-   è¿è¡Œä¸€äº›é€»è¾‘æ¥æ“ä½œè¯¥å€¼ï¼ˆä¾‹å¦‚ï¼Œè”ç³»å¤–éƒ¨ APIï¼‰
-   å°†è¯¥å€¼å†™å›æ•°æ®åº“

æ‰€æœ‰æ“ä½œéƒ½åº”**ä½œä¸ºä¸€ä¸ªæ•´ä½“æˆåŠŸæˆ–å¤±è´¥**ï¼Œè€Œä¸ä¼šå¯¹æ•°æ®åº“è¿›è¡Œä¸å¿…è¦çš„æ›´æ”¹ï¼Œä½†æ‚¨ä¸ä¸€å®šéœ€è¦ä½¿ç”¨å®é™…çš„æ•°æ®åº“äº‹åŠ¡ã€‚æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†æè¿°äº†ä½¿ç”¨ Prisma Client å’Œè¯»å–-ä¿®æ”¹-å†™å…¥æ¨¡å¼çš„ä¸¤ç§æ–¹æ³•ï¼š

-   è®¾è®¡å¹‚ç­‰ API
-   ä¹è§‚å¹¶å‘æ§åˆ¶

### å¹‚ç­‰ API (Idempotent APIs)

å¹‚ç­‰æ€§æ˜¯æŒ‡èƒ½å¤Ÿä½¿ç”¨ç›¸åŒçš„å‚æ•°å¤šæ¬¡è¿è¡Œç›¸åŒçš„é€»è¾‘å¹¶è·å¾—ç›¸åŒç»“æœçš„èƒ½åŠ›ï¼šæ— è®ºæ‚¨è¿è¡Œé€»è¾‘ä¸€æ¬¡è¿˜æ˜¯ä¸€åƒæ¬¡ï¼Œ**å¯¹æ•°æ®åº“çš„å½±å“**éƒ½æ˜¯ç›¸åŒçš„ã€‚ä¾‹å¦‚ï¼š

-   **éå¹‚ç­‰**ï¼šåœ¨æ•°æ®åº“ä¸­ä½¿ç”¨ç”µå­é‚®ä»¶åœ°å€ `"letoya@prisma.io"` æ›´æ–°æˆ–æ’å…¥ï¼ˆupsertï¼‰ç”¨æˆ·ã€‚`User` è¡¨**ä¸**å¼ºåˆ¶æ‰§è¡Œå”¯ä¸€çš„ç”µå­é‚®ä»¶åœ°å€ã€‚å¦‚æœæ‚¨è¿è¡Œé€»è¾‘ä¸€æ¬¡ï¼ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼‰æˆ–åæ¬¡ï¼ˆåˆ›å»ºåä¸ªç”¨æˆ·ï¼‰ï¼Œå¯¹æ•°æ®åº“çš„å½±å“æ˜¯ä¸åŒçš„ã€‚
-   **å¹‚ç­‰**ï¼šåœ¨æ•°æ®åº“ä¸­ä½¿ç”¨ç”µå­é‚®ä»¶åœ°å€ `"letoya@prisma.io"` æ›´æ–°æˆ–æ’å…¥ï¼ˆupsertï¼‰ç”¨æˆ·ã€‚`User` è¡¨**ç¡®å®**å¼ºåˆ¶æ‰§è¡Œå”¯ä¸€çš„ç”µå­é‚®ä»¶åœ°å€ã€‚å¦‚æœæ‚¨è¿è¡Œé€»è¾‘ä¸€æ¬¡ï¼ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼‰æˆ–åæ¬¡ï¼ˆä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ›´æ–°ç°æœ‰ç”¨æˆ·ï¼‰ï¼Œå¯¹æ•°æ®åº“çš„å½±å“æ˜¯ç›¸åŒçš„ã€‚

å¹‚ç­‰æ€§æ˜¯æ‚¨åº”è¯¥å¹¶ä¸”å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å°½å¯èƒ½ä¸»åŠ¨è®¾è®¡çš„ä¸œè¥¿ã€‚

#### ä½•æ—¶è®¾è®¡å¹‚ç­‰ API

-   âœ” æ‚¨éœ€è¦èƒ½å¤Ÿé‡è¯•ç›¸åŒçš„é€»è¾‘è€Œä¸ä¼šåœ¨æ•°æ®åº“ä¸­äº§ç”Ÿä¸å¿…è¦çš„å‰¯ä½œç”¨

#### åœºæ™¯ï¼šå‡çº§ Slack å›¢é˜Ÿ

æ‚¨æ­£åœ¨ä¸º Slack åˆ›å»ºä¸€ä¸ªå‡çº§æµç¨‹ï¼Œå…è®¸å›¢é˜Ÿè§£é”ä»˜è´¹åŠŸèƒ½ã€‚å›¢é˜Ÿå¯ä»¥åœ¨ä¸åŒçš„è®¡åˆ’ä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œå¹¶æŒ‰ç”¨æˆ·ã€æŒ‰æœˆä»˜è´¹ã€‚æ‚¨ä½¿ç”¨ Stripe ä½œä¸ºæ”¯ä»˜ç½‘å…³ï¼Œå¹¶æ‰©å±•æ‚¨çš„ `Team` æ¨¡å‹ä»¥å­˜å‚¨ `stripeCustomerId`ã€‚è®¢é˜…åœ¨ Stripe ä¸­ç®¡ç†ã€‚

```prisma highlight=5;normal
model Team {
  id               Int     @id @default(autoincrement())
  name             String
  members          User[] // 'User' åº”ä¸º 'members'
  //highlight-next-line
  stripeCustomerId String? @unique // å¯èƒ½éœ€è¦å”¯ä¸€çº¦æŸ
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  teams Team[]
}
```

å‡çº§æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

1.  è®¡ç®—ç”¨æˆ·æ•°é‡
2.  åœ¨ Stripe ä¸­åˆ›å»ºä¸€ä¸ªåŒ…å«ç”¨æˆ·æ•°é‡çš„è®¢é˜…
3.  å°†å›¢é˜Ÿä¸ Stripe å®¢æˆ· ID å…³è”ä»¥è§£é”ä»˜è´¹åŠŸèƒ½

```ts
// å‡è®¾ stripe å¯¹è±¡å·²æ­£ç¡®é…ç½®
// import Stripe from 'stripe';
// const stripe = new Stripe('your_secret_key');

const teamId = 9
const planId = 'plan_id' // æ›¿æ¢ä¸ºæ‚¨çš„å®é™… Stripe Plan ID

// è®¡ç®—å›¢é˜Ÿæˆå‘˜æ•°é‡
const numTeammates = await prisma.user.count({
  where: {
    teams: {
      some: {
        id: teamId,
      },
    },
  },
})

// åœ¨ Stripe ä¸­ä¸º plan-id åˆ›å»ºä¸€ä¸ªå®¢æˆ·å’Œè®¢é˜…
// æ³¨æ„ï¼šStripe çš„ API å¯èƒ½éœ€è¦å…ˆåˆ›å»º Customerï¼Œå†åˆ›å»º Subscription
// è¿™é‡Œçš„ 'externalId' å‡è®¾ç”¨äºå°† Stripe Customer æ˜ å°„å›æ‚¨çš„ Team ID
// Stripe å¯èƒ½æ²¡æœ‰ç›´æ¥çš„ externalId å­—æ®µï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨ metadata
let customer;
try {
  customer = await stripe.customers.create({
    metadata: { teamId: teamId.toString() }, // ä½¿ç”¨ metadata å­˜å‚¨ teamId
    // å…¶ä»–å®¢æˆ·ä¿¡æ¯...
  });

  await stripe.subscriptions.create({
    customer: customer.id,
    items: [{ plan: planId, quantity: numTeammates }],
  });

} catch (error) {
  console.error("Stripe æ“ä½œå¤±è´¥:", error);
  throw error; // æŠ›å‡ºé”™è¯¯ä»¥åœæ­¢æµç¨‹
}


// æ›´æ–°å›¢é˜Ÿçš„ customerId ä»¥è¡¨æ˜ä»–ä»¬æ˜¯å®¢æˆ·
// å¹¶æ”¯æŒä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç ä¸­æŸ¥è¯¢ Stripe ä¸­çš„æ­¤å®¢æˆ·ã€‚
await prisma.team.update({
  data: {
    stripeCustomerId: customer.id, // å­˜å‚¨ Stripe Customer ID
  },
  where: {
    id: teamId,
  },
})
```

è¿™ä¸ªä¾‹å­æœ‰ä¸€ä¸ªé—®é¢˜ï¼šä½ åªèƒ½è¿è¡Œè¿™ä¸ªé€»è¾‘*ä¸€æ¬¡*ã€‚è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼š

1.  Stripe åˆ›å»ºäº†ä¸€ä¸ªæ–°å®¢æˆ·å’Œè®¢é˜…ï¼Œå¹¶è¿”å›äº†ä¸€ä¸ªå®¢æˆ· ID
2.  æ›´æ–°å›¢é˜Ÿ**å¤±è´¥** - å›¢é˜Ÿåœ¨ Slack æ•°æ®åº“ä¸­æœªæ ‡è®°ä¸ºå®¢æˆ·
3.  å®¢æˆ·è¢« Stripe æ”¶è´¹ï¼Œä½† Slack ä¸­çš„ä»˜è´¹åŠŸèƒ½æœªè§£é”ï¼Œå› ä¸ºå›¢é˜Ÿç¼ºå°‘æœ‰æ•ˆçš„ `stripeCustomerId`
4.  å†æ¬¡è¿è¡Œç›¸åŒçš„ä»£ç è¦ä¹ˆï¼š

    -   å¯¼è‡´é”™è¯¯ï¼Œå› ä¸ºï¼ˆç”± `metadata.teamId` å®šä¹‰çš„ï¼‰å›¢é˜Ÿå·²ç»å­˜åœ¨å®¢æˆ· - Stripe ä¸ä¼šè¿”å›æ–°çš„å®¢æˆ· IDï¼ˆå¦‚æœæ‚¨çš„é€»è¾‘å°è¯•é‡æ–°åˆ›å»ºï¼‰
    -   å¦‚æœæ‚¨çš„é€»è¾‘ä¸å¤Ÿå¥å£®ï¼Œå¯èƒ½ä¼šåœ¨ Stripe ä¸­åˆ›å»ºå¦ä¸€ä¸ªè®¢é˜…ï¼ˆ**éå¹‚ç­‰**ï¼‰

å¦‚æœå‡ºç°é”™è¯¯ï¼Œæ‚¨æ— æ³•é‡æ–°è¿è¡Œæ­¤ä»£ç ï¼Œå¹¶ä¸”æ‚¨æ— æ³•æ›´æ”¹åˆ°å¦ä¸€ä¸ªè®¡åˆ’è€Œä¸ä¼šè¢«æ”¶å–ä¸¤æ¬¡è´¹ç”¨ã€‚

ä»¥ä¸‹é‡æ„ï¼ˆé«˜äº®æ˜¾ç¤ºï¼‰å¼•å…¥äº†ä¸€ç§æœºåˆ¶ï¼Œè¯¥æœºåˆ¶æ£€æŸ¥è®¢é˜…æ˜¯å¦å·²å­˜åœ¨ï¼Œå¹¶åˆ›å»ºæè¿°æˆ–æ›´æ–°ç°æœ‰è®¢é˜…ï¼ˆå¦‚æœè¾“å…¥ç›¸åŒï¼Œåˆ™ä¿æŒä¸å˜ï¼‰ï¼š

```ts highlight=13-32;normal
// å‡è®¾ stripe å’Œ prisma å·²é…ç½®
const teamId = 9;
const planId = 'plan_id'; // å®é™…çš„ Stripe Plan ID
const userEmail = 'customer@example.com'; // å‡è®¾çš„å®¢æˆ·é‚®ç®±

// è®¡ç®—å›¢é˜Ÿæˆå‘˜æ•°é‡
const numTeammates = await prisma.user.count({
  where: {
    teams: {
      some: {
        id: teamId,
      },
    },
  },
});

//highlight-start
// æŸ¥æ‰¾æˆ–åˆ›å»º Stripe å®¢æˆ·
let team = await prisma.team.findUnique({ where: { id: teamId } });
let customerId = team?.stripeCustomerId;
let customer;
let subscription;

if (customerId) {
  // å¦‚æœå·²æœ‰ customerIdï¼Œå°è¯•è·å–å®¢æˆ·å’Œæœ‰æ•ˆè®¢é˜…
  try {
    customer = await stripe.customers.retrieve(customerId);
    // æŸ¥æ‰¾ä¸æ­¤å®¢æˆ·å…³è”çš„æ­¤è®¡åˆ’çš„æœ‰æ•ˆè®¢é˜…
    const subscriptions = await stripe.subscriptions.list({ customer: customerId, plan: planId, status: 'active' });
    subscription = subscriptions.data.length > 0 ? subscriptions.data[0] : null;
  } catch (error) {
    // å¦‚æœæ£€ç´¢å¤±è´¥ï¼ˆä¾‹å¦‚å®¢æˆ·è¢«åˆ é™¤ï¼‰ï¼Œåˆ™æ¸…é™¤æœ¬åœ° customerId
    if (error.statusCode === 404) {
      console.log(`Stripe customer ${customerId} not found. Clearing local ID.`);
      await prisma.team.update({ where: { id: teamId }, data: { stripeCustomerId: null } });
      customerId = null;
    } else {
      throw error; // å…¶ä»–é”™è¯¯åˆ™æŠ›å‡º
    }
  }
}

if (!customer) {
  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®¢æˆ·æˆ–éœ€è¦åˆ›å»ºæ–°çš„
  console.log(`Creating new Stripe customer for team ${teamId}`);
  customer = await stripe.customers.create({
    email: userEmail, // éœ€è¦ä¸€ä¸ª email æˆ–å…¶ä»–æ ‡è¯†ç¬¦
    metadata: { teamId: teamId.toString() },
  });
  customerId = customer.id;
  // æ›´æ–°æœ¬åœ°æ•°æ®åº“ä¸­çš„ customerId
  await prisma.team.update({ where: { id: teamId }, data: { stripeCustomerId: customerId } });
}

if (subscription) {
  // å¦‚æœæ‰¾åˆ°æœ‰æ•ˆè®¢é˜…ï¼Œæ›´æ–°æ•°é‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
  if (subscription.items.data[0].quantity !== numTeammates) {
    console.log(`Updating subscription ${subscription.id} quantity to ${numTeammates}`);
    await stripe.subscriptionItems.update(subscription.items.data[0].id, {
      quantity: numTeammates,
    });
  } else {
    console.log(`Subscription ${subscription.id} already up-to-date.`);
  }
} else {
  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆè®¢é˜…ï¼Œåˆ›å»ºæ–°çš„
  console.log(`Creating new subscription for customer ${customerId}`);
  subscription = await stripe.subscriptions.create({
    customer: customerId,
    items: [{ plan: planId, quantity: numTeammates }],
  });
}

// ç¡®ä¿æœ¬åœ°æ•°æ®åº“çš„ stripeCustomerId æ˜¯æœ€æ–°çš„
// (å¦‚æœä¹‹å‰åˆ›å»ºäº†æ–°å®¢æˆ·ï¼Œè¿™ä¸€æ­¥æ˜¯å¤šä½™çš„ï¼Œä½†æ— å®³)
if (team?.stripeCustomerId !== customerId) {
     await prisma.team.update({ where: { id: teamId }, data: { stripeCustomerId: customerId } });
}
//highlight-end

console.log(`Team ${teamId} successfully subscribed/updated with Stripe customer ${customerId} and subscription ${subscription.id}`);

// æ³¨æ„ï¼šæ­¤ç¤ºä¾‹ä»éœ€è¦åœ¨ Prisma æ›´æ–°å¤±è´¥æ—¶å¤„ç† Stripe è®¢é˜…ï¼ˆä¾‹å¦‚ï¼Œå–æ¶ˆæˆ–è®°å½•ä»¥ä¾›æ‰‹åŠ¨å¤„ç†ï¼‰
```

æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¾“å…¥å¤šæ¬¡é‡è¯•ç›¸åŒçš„é€»è¾‘è€Œä¸ä¼šäº§ç”Ÿä¸åˆ©å½±å“ã€‚ä¸ºäº†è¿›ä¸€æ­¥å¢å¼ºæ­¤ç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥å¼•å…¥ä¸€ç§æœºåˆ¶ï¼Œå³å¦‚æœåœ¨è®¾å®šçš„å°è¯•æ¬¡æ•°åæ›´æ–°ä»æœªæˆåŠŸï¼Œåˆ™å–æ¶ˆæˆ–æš‚æ—¶åœç”¨è®¢é˜…ã€‚

### ä¹è§‚å¹¶å‘æ§åˆ¶ (Optimistic concurrency control)

ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰æ˜¯ä¸€ç§å¤„ç†å•ä¸ªå®ä½“å¹¶å‘æ“ä½œçš„æ¨¡å‹ï¼Œå®ƒä¸ä¾èµ–äºğŸ”’é”å®šã€‚ç›¸åï¼Œæˆ‘ä»¬**ä¹è§‚åœ°**å‡è®¾è®°å½•åœ¨è¯»å–å’Œå†™å…¥ä¹‹é—´ä¿æŒä¸å˜ï¼Œå¹¶ä½¿ç”¨å¹¶å‘ä»¤ç‰Œï¼ˆæ—¶é—´æˆ³æˆ–ç‰ˆæœ¬å­—æ®µï¼‰æ¥æ£€æµ‹å¯¹è®°å½•çš„æ›´æ”¹ã€‚

å¦‚æœå‘ç”ŸâŒå†²çªï¼ˆè‡ªæ‚¨è¯»å–è®°å½•ä»¥æ¥ï¼Œå…¶ä»–äººå·²æ›´æ”¹è¯¥è®°å½•ï¼‰ï¼Œåˆ™å–æ¶ˆäº‹åŠ¡ã€‚æ ¹æ®æ‚¨çš„åœºæ™¯ï¼Œæ‚¨å¯ä»¥ï¼š

-   é‡è¯•äº‹åŠ¡ï¼ˆé¢„è®¢å¦ä¸€ä¸ªç”µå½±é™¢åº§ä½ï¼‰
-   æŠ›å‡ºé”™è¯¯ï¼ˆæé†’ç”¨æˆ·ä»–ä»¬å³å°†è¦†ç›–å…¶ä»–äººæ‰€åšçš„æ›´æ”¹ï¼‰

æœ¬èŠ‚ä»‹ç»å¦‚ä½•æ„å»ºè‡ªå·±çš„ä¹è§‚å¹¶å‘æ§åˆ¶ã€‚å¦è¯·å‚é˜…ï¼š[GitHub ä¸Šå…³äºåº”ç”¨ç¨‹åºçº§ä¹è§‚å¹¶å‘æ§åˆ¶çš„è®¡åˆ’](https://github.com/prisma/prisma/issues/4988)

<Admonition type="info">

-   å¦‚æœæ‚¨ä½¿ç”¨ç‰ˆæœ¬ 4.4.0 æˆ–æ›´æ—©ç‰ˆæœ¬ï¼Œåˆ™æ— æ³•åœ¨ `update` æ“ä½œä¸Šä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œå› ä¸ºæ‚¨æ— æ³•æŒ‰éå”¯ä¸€å­—æ®µè¿›è¡Œç­›é€‰ã€‚æ‚¨éœ€è¦ä¸ä¹è§‚å¹¶å‘æ§åˆ¶ä¸€èµ·ä½¿ç”¨çš„ `version` å­—æ®µæ˜¯éå”¯ä¸€å­—æ®µã€‚
-   è‡ªç‰ˆæœ¬ 5.0.0 èµ·ï¼Œæ‚¨å¯ä»¥åœ¨ `update` æ“ä½œä¸­[æŒ‰éå”¯ä¸€å­—æ®µè¿›è¡Œç­›é€‰](/orm/reference/prisma-client-reference#filter-on-non-unique-fields-with-userwhereuniqueinput)ï¼Œä»è€Œä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶ã€‚è¯¥åŠŸèƒ½ä¹Ÿå¯é€šè¿‡é¢„è§ˆæ ‡å¿— `extendedWhereUnique` åœ¨ç‰ˆæœ¬ 4.5.0 åˆ° 4.16.2 ä¸­ä½¿ç”¨ã€‚

</Admonition>

#### ä½•æ—¶ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶

-   âœ” æ‚¨é¢„è®¡ä¼šæœ‰å¤§é‡å¹¶å‘è¯·æ±‚ï¼ˆå¤šäººé¢„è®¢ç”µå½±é™¢åº§ä½ï¼‰
-   âœ” æ‚¨é¢„è®¡è¿™äº›å¹¶å‘è¯·æ±‚ä¹‹é—´çš„å†²çªå°†å¾ˆå°‘å‘ç”Ÿ

åœ¨å…·æœ‰å¤§é‡å¹¶å‘è¯·æ±‚çš„åº”ç”¨ç¨‹åºä¸­é¿å…é”å®šï¼Œå¯ä»¥ä½¿åº”ç”¨ç¨‹åºå¯¹è´Ÿè½½æ›´å…·å¼¹æ€§ï¼Œå¹¶ä¸”æ€»ä½“ä¸Šæ›´å…·å¯ä¼¸ç¼©æ€§ã€‚è™½ç„¶é”å®šæœ¬èº«å¹¶ä¸åï¼Œä½†åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸­é”å®šå¯èƒ½å¯¼è‡´æ„æƒ³ä¸åˆ°çš„åæœ - å³ä½¿æ‚¨åªé”å®šå•ä¸ªè¡Œï¼Œå¹¶ä¸”åªé”å®šå¾ˆçŸ­çš„æ—¶é—´ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ï¼š

-   [ä¸ºä»€ä¹ˆ ROWLOCK æç¤ºä¼šä½¿ SQL Server ä¸­çš„æŸ¥è¯¢å˜æ…¢å¹¶åŠ å‰§é˜»å¡](https://kendralittle.com/2016/02/04/why-rowlock-hints-can-make-queries-slower-and-blocking-worse-in-sql-server/)

#### åœºæ™¯ï¼šåœ¨ç”µå½±é™¢é¢„è®¢åº§ä½

æ‚¨æ­£åœ¨ä¸ºç”µå½±é™¢åˆ›å»ºä¸€ä¸ªé¢„è®¢ç³»ç»Ÿã€‚æ¯éƒ¨ç”µå½±éƒ½æœ‰å›ºå®šæ•°é‡çš„åº§ä½ã€‚ä»¥ä¸‹ schema å¯¹ç”µå½±å’Œåº§ä½è¿›è¡Œå»ºæ¨¡ï¼š

```prisma // 'ts' æ”¹ä¸º 'prisma'
model Seat {
  id        Int   @id @default(autoincrement())
  userId    Int?  // å…³è”åˆ° User çš„å¤–é”®
  claimedBy User? @relation(fields: [userId], references: [id]) // å…³è”å­—æ®µ
  movieId   Int   // å…³è”åˆ° Movie çš„å¤–é”®
  movie     Movie @relation(fields: [movieId], references: [id]) // å…³è”å­—æ®µ
}

model Movie {
  id    Int    @id     @default(autoincrement())
  name  String @unique
  seats Seat[] // ä¸€å¯¹å¤šå…³ç³»
}

// éœ€è¦ User æ¨¡å‹
model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  // å¯èƒ½æœ‰å…¶ä»–å­—æ®µ
  seats Seat[] // ç”¨æˆ·é¢„è®¢çš„åº§ä½
}
```

ä»¥ä¸‹ç¤ºä¾‹ä»£ç æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨åº§ä½å¹¶å°†è¯¥åº§ä½åˆ†é…ç»™ç”¨æˆ·ï¼š

```ts
const movieName = 'Hidden Figures';
const userId = 1; // å‡è®¾çš„ç”¨æˆ· ID

// æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨åº§ä½
const availableSeat = await prisma.seat.findFirst({
  where: {
    movie: {
      name: movieName,
    },
    claimedBy: null, // æˆ–è€… userId: null
  },
});

// å¦‚æœæ²¡æœ‰å¯ç”¨åº§ä½ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
if (!availableSeat) {
  throw new Error(`å“¦ä¸ï¼ã€Š${movieName}ã€‹å·²ç»è®¢æ»¡äº†ã€‚`);
}

// é¢„å®šåº§ä½
await prisma.seat.update({
  data: {
    userId: userId, // å°†åº§ä½åˆ†é…ç»™ç”¨æˆ·
  },
  where: {
    id: availableSeat.id,
  },
});
```

ç„¶è€Œï¼Œè¿™æ®µä»£ç å­˜åœ¨â€œé‡å¤é¢„è®¢é—®é¢˜â€ - ä¸¤ä¸ªäººå¯èƒ½é¢„è®¢åˆ°åŒä¸€ä¸ªåº§ä½ï¼š

1.  åº§ä½ 3A è¿”å›ç»™ Sorchaï¼ˆ`findFirst`ï¼‰
2.  åº§ä½ 3A è¿”å›ç»™ Ellenï¼ˆ`findFirst`ï¼‰
3.  åº§ä½ 3A è¢« Sorcha é¢„è®¢ï¼ˆ`update`ï¼‰
4.  åº§ä½ 3A è¢« Ellen é¢„è®¢ï¼ˆ`update` - è¦†ç›–äº† Sorcha çš„é¢„è®¢ï¼‰

å³ä½¿ Sorcha å·²æˆåŠŸé¢„è®¢åº§ä½ï¼Œç³»ç»Ÿæœ€ç»ˆä»å­˜å‚¨ Ellen çš„é¢„è®¢ã€‚è¦ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶è§£å†³æ­¤é—®é¢˜ï¼Œè¯·å‘åº§ä½æ·»åŠ ä¸€ä¸ª `version` å­—æ®µï¼š

```prisma highlight=7;normal
model Seat {
  id        Int   @id @default(autoincrement())
  userId    Int?
  claimedBy User? @relation(fields: [userId], references: [id])
  movieId   Int
  movie     Movie @relation(fields: [movieId], references: [id])
  //highlight-next-line
  version   Int   @default(0) // æ·»åŠ ç‰ˆæœ¬å­—æ®µï¼Œé»˜è®¤ä¸º 0
}
```

æ¥ä¸‹æ¥ï¼Œè°ƒæ•´ä»£ç ä»¥åœ¨æ›´æ–°å‰æ£€æŸ¥ `version` å­—æ®µï¼š

```ts highlight=19-38;normal
const userEmail = 'alice@prisma.io'; // ä½¿ç”¨ email æˆ– userId æ ‡è¯†ç”¨æˆ·
const userId = 1; // å‡è®¾çš„ç”¨æˆ· ID
const movieName = 'Hidden Figures';

// æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨åº§ä½
// availableSeat.version å¯èƒ½æ˜¯ 0
const availableSeat = await prisma.seat.findFirst({
  where: {
    movie: { // æ³¨æ„ï¼š Prisma 5+ æ‰æ”¯æŒå…³ç³»æ¨¡å‹çš„è¿‡æ»¤
      name: movieName,
    },
    userId: null, // æ£€æŸ¥ userId æ˜¯å¦ä¸º null
  },
});

if (!availableSeat) {
  throw new Error(`å“¦ä¸ï¼ã€Š${movieName}ã€‹å·²ç»è®¢æ»¡äº†ã€‚`);
}

//highlight-start
// åªæœ‰å½“ availableSeat.version ä¸æˆ‘ä»¬æ­£åœ¨æ›´æ–°çš„ç‰ˆæœ¬åŒ¹é…æ—¶ï¼Œ
// æ‰å°†åº§ä½æ ‡è®°ä¸ºå·²é¢„è®¢ã€‚æ­¤å¤–ï¼Œåœ¨æ‰§è¡Œæ­¤æ›´æ–°æ—¶å¢åŠ ç‰ˆæœ¬å·ï¼Œ
// ä»¥ä¾¿æ‰€æœ‰å…¶ä»–è¯•å›¾é¢„è®¢åŒä¸€åº§ä½çš„å®¢æˆ·ç«¯éƒ½å°†æŒæœ‰è¿‡æ—¶çš„ç‰ˆæœ¬ã€‚
// æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ updateMany æ˜¯å› ä¸º update éœ€è¦å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œ
// è€Œ (id, version) ç»„åˆä¸æ˜¯ schema çº§åˆ«çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
// ä½† updateMany å¯ä»¥åŸºäºéå”¯ä¸€æ¡ä»¶æ›´æ–°ï¼Œå¹¶è¿”å›å—å½±å“çš„è¡Œæ•°ã€‚
const updateResult = await prisma.seat.updateMany({
  data: {
    userId: userId, // åˆ†é…ç»™ç”¨æˆ·
    version: {
      increment: 1, // ç‰ˆæœ¬å·åŠ  1
    },
  },
  where: {
    id: availableSeat.id,
    version: availableSeat.version, // è¿™æ˜¯å…³é”®ï¼›ä»…å½“å†…å­˜ä¸­çš„ç‰ˆæœ¬ä¸æ•°æ®åº“ç‰ˆæœ¬åŒ¹é…æ—¶æ‰é¢„è®¢åº§ä½ï¼Œè¡¨æ˜è¯¥å­—æ®µæœªè¢«æ›´æ–°
    userId: null, // å†æ¬¡ç¡®è®¤åº§ä½ä»ç„¶æ˜¯å¯ç”¨çš„
  },
});

if (updateResult.count === 0) {
  // å¦‚æœ count ä¸º 0ï¼Œè¡¨ç¤ºæ²¡æœ‰è¡Œè¢«æ›´æ–°ï¼Œå¯èƒ½æ˜¯å› ä¸º version ä¸åŒ¹é…æˆ–åº§ä½å·²è¢«é¢„è®¢
  throw new Error(`é‚£ä¸ªåº§ä½å·²ç»è¢«é¢„è®¢äº†ï¼è¯·å†è¯•ä¸€æ¬¡ã€‚`);
}
//highlight-end

console.log(`ç”¨æˆ· ${userId} æˆåŠŸé¢„è®¢åº§ä½ ${availableSeat.id}`);
```

ç°åœ¨ä¸¤ä¸ªäººä¸å¯èƒ½é¢„è®¢åŒä¸€ä¸ªåº§ä½äº†ï¼š

1.  åº§ä½ 3A è¿”å›ç»™ Sorchaï¼ˆ`version` ä¸º 0ï¼‰
2.  åº§ä½ 3A è¿”å›ç»™ Ellenï¼ˆ`version` ä¸º 0ï¼‰
3.  åº§ä½ 3A è¢« Sorcha é¢„è®¢ï¼ˆ`version` é€’å¢åˆ° 1ï¼Œé¢„è®¢æˆåŠŸï¼‰
4.  åº§ä½ 3A å°è¯•è¢« Ellen é¢„è®¢ï¼ˆå†…å­˜ä¸­çš„ `version` (0) ä¸æ•°æ®åº“ä¸­çš„ `version` (1) ä¸åŒ¹é… - é¢„è®¢ä¸æˆåŠŸï¼‰

### äº¤äº’å¼äº‹åŠ¡ (Interactive transactions)

å¦‚æœæ‚¨æœ‰ä¸€ä¸ªç°æœ‰çš„åº”ç”¨ç¨‹åºï¼Œå°†å…¶é‡æ„ä¸ºä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶å¯èƒ½æ˜¯ä¸€é¡¹é‡å¤§çš„ä»»åŠ¡ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œäº¤äº’å¼äº‹åŠ¡æä¾›äº†ä¸€ä¸ªæœ‰ç”¨çš„åº”æ€¥æ–¹æ¡ˆã€‚

è¦åˆ›å»ºäº¤äº’å¼äº‹åŠ¡ï¼Œè¯·å°†å¼‚æ­¥å‡½æ•°ä¼ é€’ç»™ [$transaction](#transaction-api)ã€‚

ä¼ é€’ç»™æ­¤å¼‚æ­¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Prisma Client çš„ä¸€ä¸ªå®ä¾‹ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ç§°æ­¤å®ä¾‹ä¸º `tx`ã€‚åœ¨æ­¤ `tx` å®ä¾‹ä¸Šè°ƒç”¨çš„ä»»ä½• Prisma Client è°ƒç”¨éƒ½å°è£…åœ¨äº‹åŠ¡ä¸­ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ŒAlice å’Œ Bob å„æœ‰ 100 ç¾å…ƒåœ¨ä»–ä»¬çš„è´¦æˆ·ä¸­ã€‚å¦‚æœä»–ä»¬è¯•å›¾å‘é€è¶…è¿‡ä»–ä»¬æ‹¥æœ‰çš„é‡‘é¢ï¼Œè½¬è´¦å°†è¢«æ‹’ç»ã€‚

é¢„æœŸçš„ç»“æœæ˜¯ Alice æˆåŠŸè¿›è¡Œä¸€æ¬¡ 100 ç¾å…ƒçš„è½¬è´¦ï¼Œè€Œå¦ä¸€æ¬¡è½¬è´¦å°†è¢«æ‹’ç»ã€‚è¿™å°†å¯¼è‡´ Alice æ‹¥æœ‰ 0 ç¾å…ƒï¼ŒBob æ‹¥æœ‰ 200 ç¾å…ƒã€‚

```ts
import { PrismaClient } from '@prisma/client'
const prisma = new PrismaClient()

// å‡è®¾ Account æ¨¡å‹å­˜åœ¨
// model Account {
//   id      Int    @id @default(autoincrement())
//   email   String @unique
//   balance Float
// }

async function transfer(from: string, to: string, amount: number) {
  return await prisma.$transaction(async (tx) => {
    // 1. ä»å‘é€æ–¹è´¦æˆ·æ‰£é™¤é‡‘é¢ã€‚
    const sender = await tx.account.update({
      data: {
        balance: {
          decrement: amount,
        },
      },
      where: {
        email: from,
      },
    })

    // 2. éªŒè¯å‘é€æ–¹çš„ä½™é¢æ²¡æœ‰ä½äºé›¶ã€‚
    if (sender.balance < 0) {
      throw new Error(`${from} æ²¡æœ‰è¶³å¤Ÿçš„é’±å‘é€ ${amount}`)
    }

    // 3. å°†æ”¶æ¬¾æ–¹çš„ä½™é¢å¢åŠ ç›¸åº”é‡‘é¢ã€‚
    const recipient = await tx.account.update({ // await is needed here
      data: {
        balance: {
          increment: amount,
        },
      },
      where: {
        email: to,
      },
    })

    return recipient
  })
}

async function main() {
  // å‡è®¾å·²åˆ›å»º Alice å’Œ Bob çš„è´¦æˆ·ï¼Œä½™é¢ä¸º 100
  // await prisma.account.createMany({ data: [
  //   { email: 'alice@prisma.io', balance: 100 },
  //   { email: 'bob@prisma.io', balance: 100 },
  // ]});

  try {
    // è¿™æ¬¡è½¬è´¦æˆåŠŸ
    console.log('å°è¯•ç¬¬ä¸€æ¬¡è½¬è´¦...');
    const result1 = await transfer('alice@prisma.io', 'bob@prisma.io', 100);
    console.log('ç¬¬ä¸€æ¬¡è½¬è´¦æˆåŠŸ:', result1);

    const aliceBalance1 = await prisma.account.findUnique({ where: { email: 'alice@prisma.io' } });
    const bobBalance1 = await prisma.account.findUnique({ where: { email: 'bob@prisma.io' } });
    console.log(`è½¬è´¦å: Alice balance: ${aliceBalance1?.balance}, Bob balance: ${bobBalance1?.balance}`); // åº”ä¸º Alice: 0, Bob: 200

    // è¿™æ¬¡è½¬è´¦å¤±è´¥ï¼Œå› ä¸º Alice è´¦æˆ·ä½™é¢ä¸è¶³
    console.log('å°è¯•ç¬¬äºŒæ¬¡è½¬è´¦...');
    await transfer('alice@prisma.io', 'bob@prisma.io', 100);
    console.log('ç¬¬äºŒæ¬¡è½¬è´¦æˆåŠŸï¼ˆé¢„æœŸä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼‰');

  } catch (error) {
    console.error('è½¬è´¦å¤±è´¥:', error.message);
    const aliceBalance2 = await prisma.account.findUnique({ where: { email: 'alice@prisma.io' } });
    const bobBalance2 = await prisma.account.findUnique({ where: { email: 'bob@prisma.io' } });
    console.log(`å¤±è´¥å: Alice balance: ${aliceBalance2?.balance}, Bob balance: ${bobBalance2?.balance}`); // åº”ä»ä¸º Alice: 0, Bob: 200
  } finally {
    await prisma.$disconnect();
  }
}

main()
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸¤ä¸ª `update` æŸ¥è¯¢éƒ½åœ¨æ•°æ®åº“äº‹åŠ¡å†…è¿è¡Œã€‚å½“åº”ç”¨ç¨‹åºåˆ°è¾¾å‡½æ•°æœ«å°¾æ—¶ï¼Œäº‹åŠ¡å°†**æäº¤**åˆ°æ•°æ®åº“ã€‚

å¦‚æœåº”ç”¨ç¨‹åºåœ¨æ­¤è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œå¼‚æ­¥å‡½æ•°å°†æŠ›å‡ºå¼‚å¸¸å¹¶è‡ªåŠ¨**å›æ»š**äº‹åŠ¡ã€‚

æ‚¨å¯ä»¥åœ¨æ­¤[éƒ¨åˆ†](#interactive-transactions)äº†è§£æœ‰å…³äº¤äº’å¼äº‹åŠ¡çš„æ›´å¤šä¿¡æ¯ã€‚

<Admonition type="warning">

**è¯·è°¨æ…ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡**ã€‚é•¿æ—¶é—´ä¿æŒäº‹åŠ¡
æ‰“å¼€ä¼šæŸå®³æ•°æ®åº“æ€§èƒ½ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´æ­»é”ã€‚
å°½é‡é¿å…åœ¨äº‹åŠ¡å‡½æ•°å†…éƒ¨æ‰§è¡Œç½‘ç»œè¯·æ±‚å’Œæ‰§è¡Œæ…¢æŸ¥è¯¢ã€‚
æˆ‘ä»¬å»ºè®®æ‚¨å°½å¿«å®Œæˆå¹¶é€€å‡ºï¼

</Admonition>

## ç»“è®º

Prisma Client æ”¯æŒå¤šç§å¤„ç†äº‹åŠ¡çš„æ–¹å¼ï¼Œæ—¢å¯ä»¥é€šè¿‡ API ç›´æ¥å¤„ç†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ”¯æŒæ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­å¼•å…¥ä¹è§‚å¹¶å‘æ§åˆ¶å’Œå¹‚ç­‰æ€§æ¥å¤„ç†ã€‚å¦‚æœæ‚¨è§‰å¾—æ‚¨çš„åº”ç”¨ç¨‹åºä¸­æœ‰ä»»ä½•ç”¨ä¾‹æœªè¢«ä»»ä½•å»ºè®®çš„é€‰é¡¹è¦†ç›–ï¼Œè¯·åœ¨ [GitHub ä¸Šæå‡º issue](https://github.com/prisma/prisma/issues/new/choose) ä»¥å¼€å§‹è®¨è®ºã€‚
</article>
